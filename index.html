<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Monarch 4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .card-bg { background-color: #1f2937; border: 1px solid #4b5563; }
        .btn-primary { background-color: #4f46e5; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #6366f1; }
        .nav-btn.active { background-color: #4f46e5; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #dungeon-overlay { background-color: rgba(0,0,0,0.9); }
        .gate-card { border-left: 4px solid #f59e0b; }
    </style>
</head>
<body class="text-white">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center p-4">
        <h1 class="text-5xl font-black uppercase text-indigo-400 mb-2">Project Monarch</h1>
        <p class="text-gray-400 mb-8">Your path to unrivaled strength begins.</p>
        <button id="login-btn" class="btn-primary text-white font-bold py-3 px-6 rounded-lg flex items-center">
            <i class="fab fa-google mr-3"></i> Login with Google
        </button>
    </div>

    <!-- Main App Content (Initially Hidden) -->
    <div id="app-content" class="hidden max-w-4xl mx-auto p-4">
        <header class="text-center mb-6 p-8 rounded-lg card-bg">
            <h1 id="header-title" class="text-4xl font-black uppercase text-indigo-400">Dashboard</h1>
        </header>
        
        <nav class="flex justify-center gap-2 mb-6">
            <button data-page="dashboard" class="nav-btn active px-4 py-2 rounded-lg font-semibold">Dashboard</button>
            <button data-page="workout" class="nav-btn px-4 py-2 rounded-lg font-semibold">Workout</button>
            <button data-page="architect" class="nav-btn px-4 py-2 rounded-lg font-semibold">Architect</button>
            <button data-page="settings" class="nav-btn px-4 py-2 rounded-lg font-semibold">Settings</button>
        </nav>

        <main>
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page active">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 card-bg p-6 rounded-lg text-center">
                        <div id="avatar-container" class="relative w-32 h-32 mx-auto mb-4 cursor-pointer group">
                             <div id="avatar-placeholder" class="w-full h-full rounded-full border-2 border-dashed border-gray-600 flex items-center justify-center bg-gray-800">
                                <i class="fas fa-user text-4xl text-gray-500"></i>
                            </div>
                            <img id="dashboard-avatar-img" src="" class="hidden w-full h-full rounded-full object-cover border-2 border-indigo-500">
                            <div class="absolute inset-0 rounded-full bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fas fa-camera text-white text-2xl"></i>
                            </div>
                        </div>
                        <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
                        <h2 id="player-name-display" class="text-2xl font-bold">Player</h2>
                        <button id="edit-name-btn" class="text-sm text-gray-400 hover:text-white"><i class="fas fa-pencil-alt mr-1"></i> Edit Name</button>
                    </div>
                    <div class="md:col-span-2 card-bg p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4">Achievements</h3>
                        <div id="achievements-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                             <p class="text-gray-400 col-span-full">Your legend has yet to be written. Complete quests to earn achievements.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workout Page -->
            <div id="workout-page" class="page">
                <div class="card-bg p-6 rounded-lg text-center mb-6">
                    <h2 class="text-2xl font-bold mb-2">Daily Quest</h2>
                    <p id="workout-day-title" class="text-indigo-400 font-semibold mb-4">Loading mission...</p>
                    <div id="quest-buttons" class="flex gap-4 justify-center">
                        <button id="preview-quest-btn" class="btn-primary py-2 px-4 rounded">Preview Quest</button>
                        <button id="begin-quest-btn" class="bg-green-600 hover:bg-green-500 py-2 px-4 rounded">Begin Quest</button>
                    </div>
                     <p id="rest-day-message" class="text-gray-400 hidden">Rest is when you grow stronger. Recover well.</p>
                </div>
                <div id="gate-container" class="hidden">
                    <div class="card-bg p-6 rounded-lg text-center gate-card">
                        <h2 class="text-2xl font-bold mb-2 text-amber-400">Warning: Gate Detected!</h2>
                        <p id="gate-description" class="text-gray-300 mb-4"></p>
                        <button id="complete-gate-btn" class="bg-amber-500 hover:bg-amber-400 py-2 px-4 rounded">Complete Gate Challenge</button>
                    </div>
                </div>
            </div>

            <!-- Architect Page -->
            <div id="architect-page" class="page">
                <div class="card-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Create New Routine</h2>
                    <div class="space-y-4">
                        <input id="architect-routine-name" type="text" placeholder="Routine Name" class="w-full p-2 bg-gray-800 rounded border border-gray-700 focus:border-indigo-500 focus:ring-0">
                        <div id="architect-exercise-section" class="hidden space-y-2">
                            <div class="grid grid-cols-1 sm:grid-cols-4 gap-2 items-end">
                                <div class="sm:col-span-2">
                                    <label class="text-sm text-gray-400">Add Exercise</label>
                                    <select id="architect-exercise-select" class="w-full p-2 bg-gray-800 rounded border border-gray-700 focus:border-indigo-500 focus:ring-0"></select>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Sets</label>
                                    <input id="architect-sets" type="number" placeholder="e.g., 3" class="w-full p-2 bg-gray-800 rounded border border-gray-700 focus:border-indigo-500 focus:ring-0">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Reps</label>
                                    <input id="architect-reps" type="text" placeholder="e.g., 5-8" class="w-full p-2 bg-gray-800 rounded border border-gray-700 focus:border-indigo-500 focus:ring-0">
                                </div>
                            </div>
                            <button id="architect-add-exercise-btn" class="w-full btn-primary mt-2 py-2 rounded">Add Exercise to Routine</button>
                        </div>
                        <div id="architect-routine-preview" class="mt-4 space-y-2"></div>
                        <button id="architect-save-routine-btn" class="w-full bg-green-600 hover:bg-green-500 py-2 rounded mt-4 hidden">Save Routine</button>
                    </div>
                </div>
            </div>
            
            <!-- Settings Page -->
            <div id="settings-page" class="page">
                 <div class="card-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Settings</h2>
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-red-500">Danger Zone</h3>
                        <p class="text-gray-400 text-sm">This action is irreversible. All your progress will be lost.</p>
                        <button id="delete-account-btn" class="bg-red-600 hover:bg-red-500 py-2 px-4 rounded">Delete Account</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Dungeon Overlay -->
    <div id="dungeon-overlay" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div id="dungeon-content" class="card-bg p-8 rounded-lg w-full max-w-md text-center">
            <!-- Dungeon content will be injected here -->
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Your web app's Firebase configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAK5DS4dixAQWwJ8kms2JiKr738PPKFdA4",
            authDomain: "shadowmonarch-f4a17.firebaseapp.com",
            projectId: "shadowmonarch-f4a17",
            storageBucket: "shadowmonarch-f4a17.appspot.com",
            messagingSenderId: "524012291883",
            appId: "1:524012291883:web:be243162b1c0912090276e",
            measurementId: "G-6EVHJ6EDPJ"
        };

        // --- FIREBASE INITIALIZATION ---
        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const provider = new GoogleAuthProvider();

        // --- MAIN APPLICATION OBJECT ---
        const app = {
            state: {
                user: null,
                isInitialized: false,
                playerName: 'Player',
                customAvatar: null,
                currentCustomWorkout: { name: '', exercises: [] },
                savedRoutines: [],
                achievements: [],
                level: 1,
                week: 1,
                lifts: {
                    'Squat': 20, 'Bench Press': 20, 'Deadlift': 30, 'Overhead Press': 20, 'Barbell Row': 20,
                    'Incline DB Press': 10, 'Tricep Pushdown': 15, 'Lateral Raise': 5, 'Lat Pulldown': 30,
                    'Bicep Curl': 10, 'Romanian Deadlift': 40, 'Leg Press': 50, 'Calf Raise': 40,
                    'Power Clean': 20, 'Box Jump': 0
                },
                dungeon: {
                    isActive: false,
                    currentExerciseIndex: 0,
                    exercises: []
                },
                activeGate: null,
                lastGateDate: null,
            },

            masterExerciseList: [
                'Squat', 'Bench Press', 'Deadlift', 'Overhead Press', 'Barbell Row', 
                'Romanian Deadlift', 'Front Squat', 'Hip Thrust', 'Dumbbell Bench Press', 
                'Incline DB Press', 'Dumbbell Row', 'Goblet Squat', 'Bulgarian Split Squat', 
                'Dumbbell Shoulder Press', 'Lateral Raise', 'Dumbbell Curl', 'Hammer Curl', 
                'Tricep Skullcrusher', 'Lat Pulldown', 'Cable Row', 'Tricep Pushdown', 
                'Leg Press', 'Leg Extension', 'Hamstring Curl', 'Calf Raise', 'Pull-up', 'Dip',
                'Power Clean', 'Box Jump'
            ],
            
            workoutProgram: [
                // Phase I: Foundational Strength (Weeks 1-12)
                { phase: 1, type: 'Push', exercises: [{name: 'Bench Press', sets: 3, reps: '5-8'}, {name: 'Overhead Press', sets: 3, reps: '5-8'}, {name: 'Incline DB Press', sets: 3, reps: '8-12'}] },
                { phase: 1, type: 'Pull', exercises: [{name: 'Barbell Row', sets: 3, reps: '5-8'}, {name: 'Lat Pulldown', sets: 3, reps: '8-12'}, {name: 'Bicep Curl', sets: 3, reps: '8-12'}] },
                { phase: 1, type: 'Legs', exercises: [{name: 'Squat', sets: 3, reps: '5-8'}, {name: 'Romanian Deadlift', sets: 3, reps: '8-12'}, {name: 'Leg Press', sets: 3, reps: '8-12'}] },
                // Phase II: Strength Hypertrophy (Weeks 13-24)
                { phase: 2, type: 'Push', exercises: [{name: 'Bench Press', sets: 4, reps: '4-6'}, {name: 'Overhead Press', sets: 4, reps: '4-6'}, {name: 'Lateral Raise', sets: 4, reps: '10-15'}] },
                { phase: 2, type: 'Pull', exercises: [{name: 'Deadlift', sets: 1, reps: '3-5'}, {name: 'Barbell Row', sets: 4, reps: '6-8'}, {name: 'Lat Pulldown', sets: 4, reps: '8-10'}] },
                { phase: 2, type: 'Legs', exercises: [{name: 'Squat', sets: 4, reps: '4-6'}, {name: 'Leg Press', sets: 4, reps: '10-12'}, {name: 'Hamstring Curl', sets: 3, reps: '8-12'}] },
                 // Phase III: Power & Athleticism (Weeks 25-36)
                { phase: 3, type: 'Push', exercises: [{name: 'Bench Press', sets: 5, reps: '3-5'}, {name: 'Overhead Press', sets: 5, reps: '3-5'}, {name: 'Dip', sets: 3, reps: 'AMRAP'}] },
                { phase: 3, type: 'Pull', exercises: [{name: 'Power Clean', sets: 5, reps: '3'}, {name: 'Pull-up', sets: 3, reps: 'AMRAP'}, {name: 'Barbell Row', sets: 3, reps: '8-10'}] },
                { phase: 3, type: 'Legs', exercises: [{name: 'Squat', sets: 5, reps: '3-5'}, {name: 'Box Jump', sets: 5, reps: '5'}, {name: 'Calf Raise', sets: 4, reps: '15-20'}] },
                 // Phase IV: Peak Strength (Weeks 37-48)
                { phase: 4, type: 'Push', exercises: [{name: 'Bench Press', sets: 3, reps: '5/3/1'}, {name: 'Incline DB Press', sets: 4, reps: '6-10'}, {name: 'Tricep Pushdown', sets: 4, reps: '10-12'}] },
                { phase: 4, type: 'Pull', exercises: [{name: 'Deadlift', sets: 3, reps: '5/3/1'}, {name: 'Lat Pulldown', sets: 4, reps: '8-12'}, {name: 'Bicep Curl', sets: 4, reps: '10-12'}] },
                { phase: 4, type: 'Legs', exercises: [{name: 'Squat', sets: 3, reps: '5/3/1'}, {name: 'Romanian Deadlift', sets: 4, reps: '8-10'}, {name: 'Leg Press', sets: 4, reps: '10-15'}] },
            ],
            
            gatesData: [
                { rank: 'E', description: 'Hydration Check: Drink 2L of water today.', reward: 10 },
                { rank: 'D', description: 'Cardio Burst: Complete 10 minutes of high-intensity cardio.', reward: 25 },
                { rank: 'C', description: 'Time Attack: Complete your first 3 exercises in under 20 minutes.', reward: 50 },
                { rank: 'A', description: 'Red Gate: Perform your entire workout with no more than 60 seconds of rest between sets.', reward: 100 },
                { rank: 'S', description: 'The Monarch\'s Shadow: Complete your workout, then perform 50 pull-ups.', reward: 250 },
            ],

            achievementsData: [
                { id: 'level_15', name: 'Elite Hunter', description: 'Reach Level 15.', condition: (s) => s.level >= 15, icon: 'fa-dragon' },
                { id: 'level_40', name: 'Commander Class', description: 'Reach Level 40.', condition: (s) => s.level >= 40, icon: 'fa-chess-knight' },
            ],

            // --- CORE LIFECYCLE ---
            init() {
                if (this.state.isInitialized) return;
                console.log("App Initializing...");
                this.loadData().then(() => {
                    this.generateGate();
                    this.render();
                    this.bindEvents();
                    this.state.isInitialized = true;
                    console.log("App Initialized Successfully.");
                });
            },

            async loadData() {
                if (!this.state.user) return;
                const userRef = doc(db, "users", this.state.user.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    Object.assign(this.state, data);
                } else {
                    await this.saveData();
                }
            },

            async saveData() {
                if (!this.state.user) return;
                const userRef = doc(db, "users", this.state.user.uid);
                try {
                    const stateToSave = { ...this.state };
                    delete stateToSave.user;
                    await setDoc(userRef, stateToSave, { merge: true });
                    console.log("Data saved to Firestore.");
                } catch (error) {
                    console.error("Error saving data:", error);
                    alert("Error saving progress to the cloud.");
                }
            },

            // --- EVENT BINDING ---
            bindEvents() {
                console.log("Binding all application events...");
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.showPage(btn.dataset.page));
                });
                document.getElementById('edit-name-btn').addEventListener('click', () => this.editPlayerName());
                document.getElementById('avatar-container').addEventListener('click', () => document.getElementById('avatar-upload-input').click());
                document.getElementById('avatar-upload-input').addEventListener('change', (e) => this.handleAvatarUpload(e));
                document.getElementById('architect-routine-name').addEventListener('input', (e) => this.handleRoutineNameInput(e));
                document.getElementById('architect-add-exercise-btn').addEventListener('click', () => this.addExerciseToRoutine());
                document.getElementById('architect-save-routine-btn').addEventListener('click', () => this.saveCurrentRoutine());
                document.getElementById('delete-account-btn').addEventListener('click', () => this.confirmDeleteAccount());
                document.getElementById('preview-quest-btn').addEventListener('click', () => this.previewQuest());
                document.getElementById('begin-quest-btn').addEventListener('click', () => this.beginQuest());
                document.getElementById('complete-gate-btn').addEventListener('click', () => this.completeGate());
                console.log("Event binding complete.");
            },

            // --- UI & RENDERING ---
            render() {
                this.renderDashboard();
                this.renderArchitect();
                this.renderWorkoutPage();
            },

            renderDashboard() {
                document.getElementById('player-name-display').textContent = this.state.playerName;
                const avatarImg = document.getElementById('dashboard-avatar-img');
                const avatarPlaceholder = document.getElementById('avatar-placeholder');
                if (this.state.customAvatar) {
                    avatarImg.src = this.state.customAvatar;
                    avatarImg.classList.remove('hidden');
                    avatarPlaceholder.classList.add('hidden');
                } else {
                    avatarImg.classList.add('hidden');
                    avatarPlaceholder.classList.remove('hidden');
                }
                
                const achievementsGrid = document.getElementById('achievements-grid');
                achievementsGrid.innerHTML = '';
                const unlocked = this.achievementsData.filter(ach => this.state.achievements.includes(ach.id));
                if (unlocked.length > 0) {
                    unlocked.forEach(ach => {
                        const div = document.createElement('div');
                        div.className = 'p-4 bg-gray-800 rounded-lg text-center';
                        div.innerHTML = `<i class="fas ${ach.icon} text-3xl text-indigo-400 mb-2"></i><p class="font-semibold">${ach.name}</p>`;
                        achievementsGrid.appendChild(div);
                    });
                } else {
                    achievementsGrid.innerHTML = '<p class="text-gray-400 col-span-full">Your legend has yet to be written. Complete quests to earn achievements.</p>';
                }
            },
            
            renderArchitect() {
                const previewContainer = document.getElementById('architect-routine-preview');
                previewContainer.innerHTML = '';
                 if(this.state.currentCustomWorkout.exercises.length > 0){
                    const title = document.createElement('h4');
                    title.textContent = "Routine Preview:";
                    title.className = "font-bold text-lg";
                    previewContainer.appendChild(title);
                }
                this.state.currentCustomWorkout.exercises.forEach((ex, index) => {
                    const p = document.createElement('div');
                    p.className = 'p-2 bg-gray-800 rounded flex justify-between items-center';
                    p.innerHTML = `<span>${ex.name}: ${ex.sets} sets of ${ex.reps} reps</span><button data-index="${index}" class="remove-exercise-btn text-red-500 hover:text-red-400">✖</button>`;
                    previewContainer.appendChild(p);
                });
                
                document.querySelectorAll('.remove-exercise-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        this.removeExerciseFromRoutine(index);
                    });
                });

                const saveBtn = document.getElementById('architect-save-routine-btn');
                if(this.state.currentCustomWorkout.name && this.state.currentCustomWorkout.exercises.length > 0){
                    saveBtn.classList.remove('hidden');
                } else {
                    saveBtn.classList.add('hidden');
                }
            },
            
            renderWorkoutPage() {
                const today = new Date().getDay();
                const dayIndex = today === 0 ? 6 : today - 1;
                const daySchedule = ['Push', 'Pull', 'Legs', 'Push', 'Pull', 'Legs', 'Rest'][dayIndex];
                
                const titleEl = document.getElementById('workout-day-title');
                const questBtns = document.getElementById('quest-buttons');
                const restMsg = document.getElementById('rest-day-message');

                if (daySchedule === 'Rest') {
                    titleEl.textContent = "Rest Day";
                    questBtns.classList.add('hidden');
                    restMsg.classList.remove('hidden');
                } else {
                    titleEl.textContent = `${daySchedule} Day`;
                    questBtns.classList.remove('hidden');
                    restMsg.classList.add('hidden');
                }

                const gateContainer = document.getElementById('gate-container');
                if (this.state.activeGate) {
                    document.getElementById('gate-description').textContent = `[${this.state.activeGate.rank}-Rank] ${this.state.activeGate.description}`;
                    gateContainer.classList.remove('hidden');
                } else {
                    gateContainer.classList.add('hidden');
                }
            },

            showPage(pageId) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(`${pageId}-page`).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`.nav-btn[data-page="${pageId}"]`).classList.add('active');
                document.getElementById('header-title').textContent = pageId.charAt(0).toUpperCase() + pageId.slice(1);
                if(pageId === 'architect') this.populateExerciseDropdown();
            },
            
            // --- ACTION HANDLERS ---
            editPlayerName() {
                const newName = prompt("Enter your new name:", this.state.playerName);
                if (newName && newName.trim() !== "") {
                    this.state.playerName = newName.trim();
                    this.saveData();
                    this.renderDashboard();
                }
            },

            handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.state.customAvatar = e.target.result;
                    this.saveData();
                    this.renderDashboard();
                };
                reader.readAsDataURL(file);
            },
            
            handleRoutineNameInput(event) {
                const name = event.target.value.trim();
                const exerciseSection = document.getElementById('architect-exercise-section');
                if (name) {
                    this.state.currentCustomWorkout.name = name;
                    exerciseSection.classList.remove('hidden');
                } else {
                    exerciseSection.classList.add('hidden');
                }
                this.renderArchitect();
            },
            
            populateExerciseDropdown() {
                const selectEl = document.getElementById('architect-exercise-select');
                selectEl.innerHTML = '<option value="" disabled selected>Select an exercise...</option>';
                this.masterExerciseList.forEach(exercise => {
                    const option = document.createElement('option');
                    option.value = exercise;
                    option.textContent = exercise;
                    selectEl.appendChild(option);
                });
            },

            addExerciseToRoutine() {
                const exerciseSelect = document.getElementById('architect-exercise-select');
                const setsInput = document.getElementById('architect-sets');
                const repsInput = document.getElementById('architect-reps');

                if (exerciseSelect.value && setsInput.value && repsInput.value) {
                    this.state.currentCustomWorkout.exercises.push({ 
                        name: exerciseSelect.value, 
                        sets: setsInput.value, 
                        reps: repsInput.value 
                    });
                    this.renderArchitect();
                    exerciseSelect.value = '';
                    setsInput.value = '';
                    repsInput.value = '';
                } else {
                    alert("Please fill out all exercise fields.");
                }
            },

            removeExerciseFromRoutine(index) {
                this.state.currentCustomWorkout.exercises.splice(index, 1);
                this.renderArchitect();
            },

            saveCurrentRoutine() {
                this.state.savedRoutines.push(this.state.currentCustomWorkout);
                this.saveData();
                alert(`Routine "${this.state.currentCustomWorkout.name}" saved!`);
                this.state.currentCustomWorkout = { name: '', exercises: [] };
                document.getElementById('architect-routine-name').value = '';
                document.getElementById('architect-exercise-section').classList.add('hidden');
                this.renderArchitect();
            },
            
            confirmDeleteAccount() {
                const confirmation = prompt(`This action is permanent. To delete your account, please type your name: "${this.state.playerName}"`);
                if (confirmation === this.state.playerName) {
                    deleteDoc(doc(db, "users", this.state.user.uid)).then(() => {
                        alert("Account deleted successfully.");
                        auth.signOut();
                    }).catch(error => {
                        console.error("Error deleting account:", error);
                        alert("Could not delete account. Please try again.");
                    });
                } else {
                    alert("Name does not match. Deletion cancelled.");
                }
            },
            
            // --- WORKOUT & GATE FLOW ---
            getCurrentWorkout() {
                const phase = Math.min(4, Math.floor((this.state.week - 1) / 12) + 1);
                const today = new Date().getDay();
                const dayIndex = today === 0 ? 6 : today - 1;
                const dayType = ['Push', 'Pull', 'Legs', 'Push', 'Pull', 'Legs', 'Rest'][dayIndex];
                
                if (dayType === 'Rest') return null;

                return this.workoutProgram.find(w => w.phase === phase && w.type === dayType);
            },

            previewQuest() {
                const workout = this.getCurrentWorkout();
                if (!workout) return;
                
                let previewHtml = `<h3 class="text-xl font-bold mb-4">${workout.type} Day - Phase ${workout.phase}</h3>`;
                previewHtml += '<ul class="text-left space-y-2">';
                workout.exercises.forEach(ex => {
                    previewHtml += `<li><strong>${ex.name}:</strong> ${ex.sets} sets of ${ex.reps} reps</li>`;
                });
                previewHtml += '</ul>';
                
                alert(previewHtml); // Simple alert for preview
            },

            beginQuest() {
                if (!confirm("The Dungeon awaits. Will you proceed with the quest now?")) return;
                
                const workout = this.getCurrentWorkout();
                if (!workout) return;

                this.state.dungeon.isActive = true;
                this.state.dungeon.currentExerciseIndex = 0;
                this.state.dungeon.exercises = workout.exercises;
                
                this.renderDungeon();
                document.getElementById('dungeon-overlay').classList.remove('hidden');
                document.getElementById('dungeon-overlay').classList.add('flex');
            },
            
            renderDungeon() {
                const content = document.getElementById('dungeon-content');
                if (!this.state.dungeon.isActive) {
                    content.innerHTML = '';
                    return;
                }
                
                const index = this.state.dungeon.currentExerciseIndex;
                const exercises = this.state.dungeon.exercises;

                if (index >= exercises.length) {
                    content.innerHTML = `
                        <h2 class="text-3xl font-bold text-green-400 mb-4">Quest Complete!</h2>
                        <p class="mb-6">You have cleared the dungeon. Return to base to claim your rewards.</p>
                        <button id="return-to-base-btn" class="btn-primary py-2 px-4 rounded">Return to Base</button>
                    `;
                    document.getElementById('return-to-base-btn').addEventListener('click', () => this.completeDungeon());
                } else {
                    const ex = exercises[index];
                    let setsHtml = '';
                    for (let i = 1; i <= ex.sets; i++) {
                        setsHtml += `<div class="flex items-center justify-between p-2 bg-gray-900 rounded-md mb-2">
                            <span class="font-semibold">Set ${i}</span>
                            <input type="checkbox" class="set-checkbox w-6 h-6 bg-gray-700 rounded text-indigo-500">
                        </div>`;
                    }

                    content.innerHTML = `
                        <p class="text-sm text-gray-400">Task ${index + 1} / ${exercises.length}</p>
                        <h2 class="text-3xl font-bold mb-2">${ex.name}</h2>
                        <p class="text-xl text-indigo-400 mb-4">${ex.sets} sets of ${ex.reps} reps</p>
                        <div class="space-y-2 mb-6">${setsHtml}</div>
                        <div class="flex gap-4 justify-center">
                            <button id="cancel-quest-btn" class="bg-red-600 hover:bg-red-500 py-2 px-4 rounded">Cancel Quest</button>
                            <button id="next-task-btn" class="btn-primary py-2 px-6 rounded">Next Task</button>
                        </div>
                    `;
                    document.getElementById('next-task-btn').addEventListener('click', () => this.nextDungeonTask());
                    document.getElementById('cancel-quest-btn').addEventListener('click', () => this.cancelDungeon());
                }
            },
            
            nextDungeonTask() {
                this.state.dungeon.currentExerciseIndex++;
                this.renderDungeon();
            },

            completeDungeon() {
                alert("Workout logged!");
                this.state.dungeon.isActive = false;
                document.getElementById('dungeon-overlay').classList.add('hidden');
                document.getElementById('dungeon-overlay').classList.remove('flex');
                this.saveData();
            },

            cancelDungeon() {
                if(confirm("Are you sure you want to abandon the quest? Your progress will not be saved.")){
                    this.state.dungeon.isActive = false;
                    document.getElementById('dungeon-overlay').classList.add('hidden');
                    document.getElementById('dungeon-overlay').classList.remove('flex');
                }
            },
            
            generateGate() {
                const today = new Date().toISOString().split('T')[0];
                if (this.state.lastGateDate === today) return; // Only one gate per day

                if (Math.random() < 0.5) { // 50% chance of a gate appearing
                    this.state.activeGate = this.gatesData[Math.floor(Math.random() * this.gatesData.length)];
                    this.state.lastGateDate = today;
                    this.saveData();
                }
            },

            completeGate() {
                alert(`Gate Cleared! You earned ${this.state.activeGate.reward} XP.`);
                // In a real app, you'd add XP here: this.state.level += ...
                this.state.activeGate = null;
                this.saveData();
                this.renderWorkoutPage();
            }
        };

        // --- AUTHENTICATION LISTENER ---
        onAuthStateChanged(auth, (user) => {
            const loginScreen = document.getElementById('login-screen');
            const appContent = document.getElementById('app-content');

            if (user) {
                console.log("User is signed in:", user.uid);
                app.state.user = user;
                loginScreen.classList.add('hidden');
                appContent.classList.remove('hidden');
                app.init();
            } else {
                console.log("User is signed out.");
                loginScreen.classList.remove('hidden');
                appContent.classList.add('hidden');
                app.state.isInitialized = false;
            }
        });

        // --- LOGIN BUTTON ---
        document.getElementById('login-btn').addEventListener('click', () => {
            signInWithPopup(auth, provider).catch((error) => {
                console.error("Login failed:", error);
                alert("Login failed. Please check your Firebase setup and authorized domains.");
            });
        });

    </script>
</body>
</html>
