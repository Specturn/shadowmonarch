<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Monarch 4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .card-bg { background-color: #1f2937; border: 1px solid #4b5563; }
        .btn-primary { background-color: #4f46e5; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #6366f1; }
        .nav-btn.active { background-color: #4f46e5; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #dungeon-overlay { background-color: rgba(0,0,0,0.9); }
        .gate-card { border-left: 4px solid #f59e0b; }
        .achievement-locked { opacity: 0.6; filter: grayscale(80%); }
        .progress-bar { height: 8px; background-color: #374151; border-radius: 9999px; overflow: hidden; }
        .progress-bar-inner { height: 100%; background-color: #4f46e5; }
        /* Modal */
        #modal-overlay { background-color: rgba(0,0,0,0.7); }
        .modal-card { background-color: #111827; border: 1px solid #374151; }
        .modal-btn { background-color: #374151; }
        .modal-btn.primary { background-color: #4f46e5; }
        /* Particles containers */
        #particles-login, #particles-dashboard { position: absolute; inset: 0; z-index: 0; pointer-events: none; }
        .with-particles { position: relative; }
        /* Level up animation */
        .level-up { animation: pulseGlow 1.2s ease-out 1; }
        @keyframes pulseGlow { 0% { transform: scale(0.9); box-shadow: 0 0 0px #4f46e5; } 50% { transform: scale(1.03); box-shadow: 0 0 30px #6366f180; } 100% { transform: scale(1); box-shadow: 0 0 0px transparent; } }

        .custom-select-container {
            position: relative;
        }
        .custom-select-value {
            background-color: #27272a;
            border: 1px solid #52525b;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #27272a;
            border: 1px solid #52525b;
            border-radius: 0.375rem;
            margin-top: 0.25rem;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }
        .custom-select-option {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .custom-select-option:hover {
            background-color: #4f46e5;
        }
    </style>
    <!-- Chart.js and particles.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
</head>
<body class="text-white">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen with-particles flex flex-col items-center justify-center p-4">
        <div id="particles-login"></div>
        <h1 class="text-5xl font-black uppercase text-indigo-400 mb-2">Project Monarch</h1>
        <p class="text-gray-400 mb-8">Your path to unrivaled strength begins.</p>
        <button id="login-btn" class="btn-primary text-white font-bold py-3 px-6 rounded-lg flex items-center">
            <i class="fab fa-google mr-3"></i> Login with Google
        </button>
    </div>

    <!-- Main App Content (Initially Hidden) -->
    <div id="app-content" class="hidden max-w-4xl mx-auto p-4 with-particles">
        <div id="particles-dashboard"></div>
        <header class="relative z-10 text-center mb-6 p-8 rounded-lg card-bg">
            <h1 id="header-title" class="text-4xl font-black uppercase text-indigo-400">Dashboard</h1>
        </header>
        
        <nav class="flex justify-center gap-2 mb-6">
            <button data-page="dashboard" data-action="nav:dashboard" class="nav-btn active px-4 py-2 rounded-lg font-semibold">Dashboard</button>
            <button data-page="workout" data-action="nav:workout" class="nav-btn px-4 py-2 rounded-lg font-semibold">Workout</button>
            <button data-page="gates" data-action="nav:gates" class="nav-btn px-4 py-2 rounded-lg font-semibold">Gates</button>
            <button data-page="architect" data-action="nav:architect" class="nav-btn px-4 py-2 rounded-lg font-semibold">Architect</button>
            <button data-page="achievements" data-action="nav:achievements" class="nav-btn px-4 py-2 rounded-lg font-semibold">Achievements</button>
            <button data-page="settings" data-action="nav:settings" class="nav-btn px-4 py-2 rounded-lg font-semibold">Settings</button>
        </nav>

        <main>
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page active">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6 relative z-10">
                    <div class="md:col-span-1 card-bg p-6 rounded-lg text-center">
                        <div id="avatar-container" class="relative w-32 h-32 mx-auto mb-4 cursor-pointer group">
                             <div id="avatar-placeholder" class="w-full h-full rounded-full border-2 border-dashed border-gray-600 flex items-center justify-center bg-gray-800">
                                <i class="fas fa-user text-4xl text-gray-500"></i>
                            </div>
                            <img id="dashboard-avatar-img" src="" class="hidden w-full h-full rounded-full object-cover border-2 border-indigo-500">
                            <div class="absolute inset-0 rounded-full bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fas fa-camera text-white text-2xl"></i>
                            </div>
                        </div>
                        <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
                        <h2 id="player-name-display" class="text-2xl font-bold">Player</h2>
                        <button id="edit-name-btn" data-action="player:editName" class="text-sm text-gray-400 hover:text-white"><i class="fas fa-pencil-alt mr-1"></i> Edit Name</button>
                        <div class="grid grid-cols-2 gap-3 mt-4 text-left">
                            <div class="p-3 bg-gray-800 rounded">
                                <p class="text-xs uppercase text-gray-400">Level</p>
                                <p id="pc-level" class="text-xl font-bold">1</p>
                    </div>
                            <div class="p-3 bg-gray-800 rounded">
                                <p class="text-xs uppercase text-gray-400">Current Streak</p>
                                <p id="pc-streak" class="text-xl font-bold">0</p>
                            </div>
                            <div class="p-3 bg-gray-800 rounded col-span-2">
                                <p class="text-xs uppercase text-gray-400">Longest Streak</p>
                                <p id="pc-longest" class="text-xl font-bold">0</p>
                            </div>
                        </div>
                        <div class="mt-4 text-left">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold">Showcased Achievements</p>
                                <button data-action="player:selectShowcase" class="text-xs px-2 py-1 bg-gray-800 rounded border border-gray-700 hover:border-indigo-500">Select Showcase</button>
                            </div>
                            <div id="showcase-achievements" class="grid grid-cols-3 gap-2"></div>
                        </div>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-1 gap-6">
                        <div class="card-bg p-6 rounded-lg grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <p class="text-xs uppercase text-gray-400">Level</p>
                                <p id="stat-level" class="text-2xl font-bold">1</p>
                                <div class="progress-bar mt-2"><div id="xp-bar" class="progress-bar-inner" style="width: 0%"></div></div>
                                <p id="stat-xp" class="text-xs text-gray-400 mt-1">0 / 100 XP</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs uppercase text-gray-400">Mana</p>
                                <p id="stat-mana" class="text-2xl font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs uppercase text-gray-400">Streak</p>
                                <p id="stat-streak" class="text-2xl font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs uppercase text-gray-400">Workouts</p>
                                <p id="stat-workouts" class="text-2xl font-bold">0</p>
                            </div>
                        </div>

                        <div class="card-bg p-6 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-xl font-bold">Strength Profile</h3>
                            </div>
                            <canvas id="radar-chart" height="120"></canvas>
                        </div>

                        <div class="card-bg p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4">Achievements</h3>
                        <div id="achievements-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                             <p class="text-gray-400 col-span-full">Your legend has yet to be written. Complete quests to earn achievements.</p>
                            </div>
                        </div>
                    </div>
                    <div id="activity-calendar-container" class="md:col-span-3 card-bg p-6 rounded-lg mt-6"></div>
                </div>
            </div>

            <!-- Workout Page -->
            <div id="workout-page" class="page">
                <div class="card-bg p-6 rounded-lg text-center mb-6">
                    <h2 class="text-2xl font-bold mb-2">Daily Quest</h2>
                    <p id="workout-day-title" class="text-indigo-400 font-semibold mb-4">Loading mission...</p>
                    <div id="quest-buttons" class="flex gap-4 justify-center">
                        <button id="preview-quest-btn" data-action="workout:preview" class="btn-primary py-2 px-4 rounded">Preview Quest</button>
                        <button id="begin-quest-btn" data-action="workout:begin" class="bg-green-600 hover:bg-green-500 py-2 px-4 rounded">Begin Quest</button>
                    </div>
                     <p id="rest-day-message" class="text-gray-400 hidden">Rest is when you grow stronger. Recover well.</p>
                </div>
                <div id="gate-container" class="hidden">
                    <div class="card-bg p-6 rounded-lg text-center gate-card">
                        <h2 class="text-2xl font-bold mb-2 text-amber-400">Warning: Gate Detected!</h2>
                        <p id="gate-description" class="text-gray-300 mb-4"></p>
                        <button id="complete-gate-btn" data-action="gate:complete" class="bg-amber-500 hover:bg-amber-400 py-2 px-4 rounded">Complete Gate Challenge</button>
                    </div>
                </div>
            </div>

            <!-- Architect Page -->
            <div id="architect-page" class="page">
                <div class="card-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Create New Routine</h2>
                    <div class="space-y-4">
                        <input id="architect-routine-name" type="text" placeholder="Routine Name" class="w-full p-2 bg-gray-800 rounded border border-gray-700 focus:border-indigo-500 focus:ring-0">
                        <div id="architect-exercise-section" class="hidden space-y-2">
                            <div class="grid grid-cols-1 sm:grid-cols-4 gap-2 items-end">
                                <div class="sm:col-span-2">
                                    <label class="text-sm text-gray-400">Add Exercise</label>
                                    <div id="architect-exercise-dropdown-container"></div>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Sets</label>
                                    <input id="architect-sets" type="number" placeholder="e.g., 3" class="w-full p-2 bg-gray-800 rounded border border-gray-700 focus:border-indigo-500 focus:ring-0">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Reps</label>
                                    <input id="architect-reps" type="text" placeholder="e.g., 5-8" class="w-full p-2 bg-gray-800 rounded border border-gray-700 focus:border-indigo-500 focus:ring-0">
                                </div>
                            </div>
                            <button id="architect-add-exercise-btn" class="w-full btn-primary mt-2 py-2 rounded">Add Exercise to Routine</button>
                        </div>
                        <div id="architect-routine-preview" class="mt-4 space-y-2"></div>
                        <button id="architect-save-routine-btn" class="w-full bg-green-600 hover:bg-green-500 py-2 rounded mt-4 hidden">Save Routine</button>
                    </div>
                </div>
            </div>
            
            <!-- Gates Page -->
            <div id="gates-page" class="page">
                <div class="card-bg p-6 rounded-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold">Active Gates</h2>
                        <!-- Gate spawning is automatic and random -->
                    </div>
                    <div id="gates-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>

            <!-- Achievements Page -->
            <div id="achievements-page" class="page">
                <div class="card-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Trophy Case</h2>
                    <div id="achievements-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>
            
            <!-- Settings Page -->
            <div id="settings-page" class="page">
                 <div class="card-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Settings</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Difficulty</label>
                            <div id="difficulty-dropdown-container"></div>
                            <p class="text-xs text-gray-500 mt-1">Easy: +1.25 kg, Normal: +2.5 kg, Hard: +5 kg</p>
                        </div>
                        <h3 class="text-lg font-semibold text-red-500">Danger Zone</h3>
                        <p class="text-gray-400 text-sm">This action is irreversible. All your progress will be lost.</p>
                        <button id="delete-account-btn" data-action="settings:delete" class="bg-red-600 hover:bg-red-500 py-2 px-4 rounded">Delete Account</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Dungeon Overlay -->
    <div id="dungeon-overlay" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div id="dungeon-content" class="card-bg p-6 rounded-lg w-full max-w-xl text-left">
            <!-- Dungeon content will be injected here -->
        </div>
    </div>

    <!-- Global Modal Overlay -->
    <div id="modal-overlay" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal-card w-full max-w-lg p-6 rounded-xl">
            <div class="flex items-start justify-between mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-white">Modal</h3>
                <button id="modal-close" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-body" class="text-gray-200"></div>
            <div id="modal-actions" class="mt-6 flex gap-3 justify-end"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Your web app's Firebase configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAK5DS4dixAQWwJ8kms2JiKr738PPKFdA4",
            authDomain: "shadowmonarch-f4a17.firebaseapp.com",
            projectId: "shadowmonarch-f4a17",
            storageBucket: "shadowmonarch-f4a17.appspot.com",
            messagingSenderId: "524012291883",
            appId: "1:524012291883:web:be243162b1c0912090276e",
            measurementId: "G-6EVHJ6EDPJ"
        };

        // --- FIREBASE INITIALIZATION ---
        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const provider = new GoogleAuthProvider();

        // --- MAIN APPLICATION OBJECT ---
        const app = {
            state: {
                user: null,
                isInitialized: false,
                playerName: 'Player',
                customAvatar: null,
                currentArchitectExercise: null,
                currentCustomWorkout: { name: '', exercises: [] },
                savedRoutines: [],
                achievements: [],
                level: 1,
                xp: 0,
                xpToNextLevel: 100,
                mana: 0,
                week: 1,
                difficulty: 'Normal',
                lifts: {
                    'Squat': { weight: 20 }, 'Bench Press': { weight: 20 }, 'Deadlift': { weight: 30 }, 'Overhead Press': { weight: 20 }, 'Barbell Row': { weight: 20 },
                    'Incline DB Press': { weight: 10 }, 'Tricep Pushdown': { weight: 15 }, 'Lateral Raise': { weight: 5 }, 'Lat Pulldown': { weight: 30 },
                    'Bicep Curl': { weight: 10 }, 'Romanian Deadlift': { weight: 40 }, 'Leg Press': { weight: 50 }, 'Calf Raise': { weight: 40 },
                    'Power Clean': { weight: 20 }, 'Box Jump': { weight: 0 }
                },
                dungeon: {
                    isActive: false,
                    currentExerciseIndex: 0,
                    exercises: []
                },
                activeGate: null,
                lastGateDate: null,
                lastWorkoutDate: null,
                streak: 0,
                stats: { dungeonsCleared: 0, gatesCleared: 0, sRanksCleared: 0, aRanksCleared: 0, bRanksCleared: 0, cRanksCleared: 0, dRanksCleared: 0, eRanksCleared: 0, totalWorkouts: 0, totalVolumeKg: 0, maxVolumeInSession: 0 },
                liftHistory: { 'Squat': [], 'Bench Press': [], 'Deadlift': [], 'Overhead Press': [] },
                longestStreak: 0,
                showcase: [],
                gates: [],
                completedGates: [],
                activityLog: [],
                calendar: {
                    viewDate: new Date()
                },
            },

            masterExerciseList: [
                'Squat', 'Bench Press', 'Deadlift', 'Overhead Press', 'Barbell Row', 
                'Romanian Deadlift', 'Front Squat', 'Hip Thrust', 'Dumbbell Bench Press', 
                'Incline DB Press', 'Dumbbell Row', 'Goblet Squat', 'Bulgarian Split Squat', 
                'Dumbbell Shoulder Press', 'Lateral Raise', 'Dumbbell Curl', 'Hammer Curl', 
                'Tricep Skullcrusher', 'Lat Pulldown', 'Cable Row', 'Tricep Pushdown', 
                'Leg Press', 'Leg Extension', 'Hamstring Curl', 'Calf Raise', 'Pull-up', 'Dip',
                'Power Clean', 'Box Jump'
            ],
            
            workoutProgram: [
    // Phase I: Foundational Strength (Weeks 1-12)
    { phase: 1, type: 'Push', exercises: [
        {name: 'Bench Press', sets: 3, reps: '5-8', instructions: ['Lie flat on the bench with your feet firmly on the floor.', 'Grip the bar slightly wider than shoulder-width.', 'Lower the bar to your mid-chest, keeping your elbows tucked at about a 45-degree angle.', 'Press the bar back up until your arms are fully extended.']},
        {name: 'Overhead Press', sets: 3, reps: '5-8', instructions: ['Stand with the bar on your front shoulders, hands slightly wider than shoulder-width.', 'Keep your core tight and glutes squeezed.', 'Press the bar straight overhead until your arms are locked out.', 'Slowly lower the bar back to the starting position.']},
        {name: 'Incline DB Press', sets: 3, reps: '8-12', instructions: ['Set an incline bench to 30-45 degrees.', 'Lie back with a dumbbell in each hand at shoulder level.', 'Press the dumbbells up until they meet above your chest.', 'Lower the dumbbells slowly and with control.']}
    ]},
    { phase: 1, type: 'Pull', exercises: [
        {name: 'Barbell Row', sets: 3, reps: '5-8', instructions: ['Stand with your mid-foot under the barbell.', 'Bend at the hips and knees and grip the bar with a slightly wider than shoulder-width grip.', 'Keeping your back straight, pull the bar towards your lower chest.', 'Squeeze your back muscles at the top, then slowly lower the bar.']},
        {name: 'Lat Pulldown', sets: 3, reps: '8-12', instructions: ['Grip the bar with a wide, overhand grip.', 'Sit down and secure your knees under the pads.', 'Pull the bar down to your upper chest, squeezing your lats.', 'Slowly return the bar to the starting position.']},
        {name: 'Bicep Curl', sets: 3, reps: '8-12', instructions: ['Stand holding a dumbbell in each hand with an underhand grip.', 'Keeping your elbows at your sides, curl the weights up to shoulder level.', 'Squeeze your biceps at the top.', 'Slowly lower the weights back down.']}
    ]},
    { phase: 1, type: 'Legs', exercises: [
        {name: 'Squat', sets: 3, reps: '5-8', instructions: ['Place the barbell on your upper back, not your neck.', 'Stand with your feet shoulder-width apart, toes slightly out.', 'Keep your chest up and back straight as you squat down until your thighs are at least parallel to the floor.', 'Drive through your heels to return to the starting position.']},
        {name: 'Romanian Deadlift', sets: 3, reps: '8-12', instructions: ['Hold a barbell or dumbbells in front of your thighs.', 'Keeping your legs almost straight (a slight bend in the knees), hinge at your hips.', 'Lower the weight until you feel a deep stretch in your hamstrings.', 'Return to the starting position by squeezing your glutes.']},
        {name: 'Leg Press', sets: 3, reps: '8-12', instructions: ['Sit on the machine with your feet shoulder-width apart on the platform.', 'Press the platform away from you until your legs are extended, but not locked.', 'Slowly lower the weight back to the starting position.']}
    ]},
    // Phase II: Strength Hypertrophy (Weeks 13-24)
    { phase: 2, type: 'Push', exercises: [
        {name: 'Bench Press', sets: 4, reps: '4-6', instructions: ['Lie flat on the bench with your feet firmly on the floor.', 'Grip the bar slightly wider than shoulder-width.', 'Lower the bar to your mid-chest, keeping your elbows tucked at about a 45-degree angle.', 'Press the bar back up until your arms are fully extended.']},
        {name: 'Overhead Press', sets: 4, reps: '4-6', instructions: ['Stand with the bar on your front shoulders, hands slightly wider than shoulder-width.', 'Keep your core tight and glutes squeezed.', 'Press the bar straight overhead until your arms are locked out.', 'Slowly lower the bar back to the starting position.']},
        {name: 'Lateral Raise', sets: 4, reps: '10-15', instructions: ['Stand with dumbbells at your sides, palms facing in.', 'Keeping a slight bend in your elbows, raise the weights out to your sides until they are at shoulder level.', 'Pause at the top, then slowly lower the weights back down.']}
    ]},
    { phase: 2, type: 'Pull', exercises: [
        {name: 'Deadlift', sets: 1, reps: '3-5', instructions: ['Stand with your mid-foot under the bar.', 'Hinge at your hips and bend your knees to grip the bar.', 'Keep your back straight, chest up, and pull the weight off the floor by extending your hips and knees.', 'Lower the bar with control.']},
        {name: 'Barbell Row', sets: 4, reps: '6-8', instructions: ['Stand with your mid-foot under the barbell.', 'Bend at the hips and knees and grip the bar with a slightly wider than shoulder-width grip.', 'Keeping your back straight, pull the bar towards your lower chest.', 'Squeeze your back muscles at the top, then slowly lower the bar.']},
        {name: 'Lat Pulldown', sets: 4, reps: '8-10', instructions: ['Grip the bar with a wide, overhand grip.', 'Sit down and secure your knees under the pads.', 'Pull the bar down to your upper chest, squeezing your lats.', 'Slowly return the bar to the starting position.']}
    ]},
    { phase: 2, type: 'Legs', exercises: [
        {name: 'Squat', sets: 4, reps: '4-6', instructions: ['Place the barbell on your upper back, not your neck.', 'Stand with your feet shoulder-width apart, toes slightly out.', 'Keep your chest up and back straight as you squat down until your thighs are at least parallel to the floor.', 'Drive through your heels to return to the starting position.']},
        {name: 'Leg Press', sets: 4, reps: '10-12', instructions: ['Sit on the machine with your feet shoulder-width apart on the platform.', 'Press the platform away from you until your legs are extended, but not locked.', 'Slowly lower the weight back to the starting position.']},
        {name: 'Hamstring Curl', sets: 3, reps: '8-12', instructions: ['Lie face down on the hamstring curl machine.', 'Position your Achilles tendon under the pad.', 'Curl your legs up towards your glutes.', 'Slowly lower the weight back down.']}
    ]},
     // Phase III: Power & Athleticism (Weeks 25-36)
    { phase: 3, type: 'Push', exercises: [
        {name: 'Bench Press', sets: 5, reps: '3-5', instructions: ['Lie flat on the bench with your feet firmly on the floor.', 'Grip the bar slightly wider than shoulder-width.', 'Lower the bar to your mid-chest, keeping your elbows tucked at about a 45-degree angle.', 'Press the bar back up until your arms are fully extended.']},
        {name: 'Overhead Press', sets: 5, reps: '3-5', instructions: ['Stand with the bar on your front shoulders, hands slightly wider than shoulder-width.', 'Keep your core tight and glutes squeezed.', 'Press the bar straight overhead until your arms are locked out.', 'Slowly lower the bar back to the starting position.']},
        {name: 'Dip', sets: 3, reps: 'AMRAP', instructions: ['Grip the parallel bars firmly.', 'Lower your body until your shoulders are below your elbows.', 'Press back up to the starting position.', 'AMRAP means As Many Reps As Possible.']}
    ]},
    { phase: 3, type: 'Pull', exercises: [
        {name: 'Power Clean', sets: 5, reps: '3', instructions: ['Start with the barbell on the floor, similar to a deadlift.', 'Explosively pull the bar up, extending your hips and knees.', 'As the bar passes your thighs, shrug and pull yourself under it.', 'Catch the bar on your front shoulders in a squat position and stand up.']},
        {name: 'Pull-up', sets: 3, reps: 'AMRAP', instructions: ['Grip the bar with an overhand grip, slightly wider than shoulder-width.', 'Pull your chest up to the bar.', 'Lower yourself back down with control.', 'AMRAP means As Many Reps As Possible.']},
        {name: 'Barbell Row', sets: 3, reps: '8-10', instructions: ['Stand with your mid-foot under the barbell.', 'Bend at the hips and knees and grip the bar with a slightly wider than shoulder-width grip.', 'Keeping your back straight, pull the bar towards your lower chest.', 'Squeeze your back muscles at the top, then slowly lower the bar.']}
    ]},
    { phase: 3, type: 'Legs', exercises: [
        {name: 'Squat', sets: 5, reps: '3-5', instructions: ['Place the barbell on your upper back, not your neck.', 'Stand with your feet shoulder-width apart, toes slightly out.', 'Keep your chest up and back straight as you squat down until your thighs are at least parallel to the floor.', 'Drive through your heels to return to the starting position.']},
        {name: 'Box Jump', sets: 5, reps: '5', instructions: ['Stand in front of a sturdy box.', 'Dip into a quarter squat and explode up, swinging your arms.', 'Land softly on the box with your knees bent.', 'Step down, do not jump down.']},
        {name: 'Calf Raise', sets: 4, reps: '15-20', instructions: ['Stand with the balls of your feet on an elevated surface.', 'Lower your heels as far as you can to feel a stretch.', 'Press up onto your toes as high as possible.', 'Squeeze your calves at the top.']}
    ]},
     // Phase IV: Peak Strength (Weeks 37-48)
    { phase: 4, type: 'Push', exercises: [
        {name: 'Bench Press', sets: 3, reps: '5/3/1', instructions: ['The 5/3/1 program involves different rep schemes each week.', 'Week 1: 3x5, Week 2: 3x3, Week 3: 1x5, 1x3, 1x1.', 'Perform warm-up sets before your main working sets.', 'Focus on lifting heavy with good form.']},
        {name: 'Incline DB Press', sets: 4, reps: '6-10', instructions: ['Set an incline bench to 30-45 degrees.', 'Lie back with a dumbbell in each hand at shoulder level.', 'Press the dumbbells up until they meet above your chest.', 'Lower the dumbbells slowly and with control.']},
        {name: 'Tricep Pushdown', sets: 4, reps: '10-12', instructions: ['Attach a straight bar or rope to a high pulley.', 'Grip the attachment and press down until your arms are fully extended.', 'Keep your elbows close to your body.', 'Slowly return to the starting position.']}
    ]},
    { phase: 4, type: 'Pull', exercises: [
        {name: 'Deadlift', sets: 3, reps: '5/3/1', instructions: ['The 5/3/1 program involves different rep schemes each week.', 'Week 1: 3x5, Week 2: 3x3, Week 3: 1x5, 1x3, 1x1.', 'Perform warm-up sets before your main working sets.', 'Maintain a flat back throughout the lift.']},
        {name: 'Lat Pulldown', sets: 4, reps: '8-12', instructions: ['Grip the bar with a wide, overhand grip.', 'Sit down and secure your knees under the pads.', 'Pull the bar down to your upper chest, squeezing your lats.', 'Slowly return the bar to the starting position.']},
        {name: 'Bicep Curl', sets: 4, reps: '10-12', instructions: ['Stand holding a dumbbell in each hand with an underhand grip.', 'Keeping your elbows at your sides, curl the weights up to shoulder level.', 'Squeeze your biceps at the top.', 'Slowly lower the weights back down.']}
    ]},
    { phase: 4, type: 'Legs', exercises: [
        {name: 'Squat', sets: 3, reps: '5/3/1', instructions: ['The 5/3/1 program involves different rep schemes each week.', 'Week 1: 3x5, Week 2: 3x3, Week 3: 1x5, 1x3, 1x1.', 'Perform warm-up sets before your main working sets.', 'Focus on depth and control on every rep.']},
        {name: 'Romanian Deadlift', sets: 4, reps: '8-10', instructions: ['Hold a barbell or dumbbells in front of your thighs.', 'Keeping your legs almost straight (a slight bend in the knees), hinge at your hips.', 'Lower the weight until you feel a deep stretch in your hamstrings.', 'Return to the starting position by squeezing your glutes.']},
        {name: 'Leg Press', sets: 4, reps: '10-15', instructions: ['Sit on the machine with your feet shoulder-width apart on the platform.', 'Press the platform away from you until your legs are extended, but not locked.', 'Slowly lower the weight back to the starting position.']}
    ]},
],
            
            gatesData: [
                { rank: 'E', description: 'Active Recovery: Perform 15 minutes of light stretching or foam rolling.', reward: 10 },
                { rank: 'D', description: 'Grip Strength Test: Perform a dead hang from a pull-up bar for at least 30 seconds.', reward: 25 },
                { rank: 'C', description: 'Finisher: After your main workout, perform 100 push-ups in as few sets as possible.', reward: 50 },
                { rank: 'B', description: 'Endurance Trial: Complete 30 minutes of steady-state cardio (running, cycling, etc.).', reward: 75 },
                { rank: 'A', description: 'Red Gate: Perform your entire workout with no more than 60 seconds of rest between sets.', reward: 100 },
                { rank: 'S', description: 'The Monarch\'s Shadow: Complete your workout, then set a new personal record on any bodyweight exercise (pull-ups, dips, etc.).', reward: 250 },
            ],

            achievementsData: [
                // Level Milestones
                { id: 'level_5', name: 'Hunter Rank E', description: 'Reach Level 5.', icon: 'fa-user-shield', target: 5, progress: (s) => s.level },
                { id: 'level_10', name: 'Hunter Rank D', description: 'Reach Level 10.', icon: 'fa-user-shield', target: 10, progress: (s) => s.level },
                { id: 'level_15', name: 'Hunter Rank C', description: 'Reach Level 15.', icon: 'fa-user-ninja', target: 15, progress: (s) => s.level },
                { id: 'level_25', name: 'Hunter Rank B', description: 'Reach Level 25.', icon: 'fa-user-ninja', target: 25, progress: (s) => s.level },
                { id: 'level_35', name: 'Hunter Rank B+', description: 'Reach Level 35.', icon: 'fa-user-astronaut', target: 35, progress: (s) => s.level },
                { id: 'level_50', name: 'Hunter Rank A', description: 'Reach Level 50.', icon: 'fa-user-astronaut', target: 50, progress: (s) => s.level },
                { id: 'level_60', name: 'Hunter Rank A+', description: 'Reach Level 60.', icon: 'fa-crown', target: 60, progress: (s) => s.level },
                { id: 'level_75', name: 'Hunter Rank S', description: 'Reach Level 75.', icon: 'fa-crown', target: 75, progress: (s) => s.level },
                { id: 'level_80', name: 'Hunter Rank S+', description: 'Reach Level 80.', icon: 'fa-shield-halved', target: 80, progress: (s) => s.level },
                { id: 'level_90', name: 'National Level Hunter', description: 'Reach Level 90.', icon: 'fa-shield-halved', target: 90, progress: (s) => s.level },
                { id: 'level_100', name: 'Monarch', description: 'Reach Level 100.', icon: 'fa-king', target: 100, progress: (s) => s.level },

                // Strength Plateaus (KG)
                { id: 'squat_60', name: 'First Steps', description: 'Squat 60kg.', icon: 'fa-shoe-prints', target: 60, progress: (s) => s.lifts['Squat'] ? s.lifts['Squat'].weight : 0 },
                { id: 'squat_80', name: 'Solid Ground', description: 'Squat 80kg.', icon: 'fa-mountain', target: 80, progress: (s) => s.lifts['Squat'] ? s.lifts['Squat'].weight : 0 },
                { id: 'squat_100', name: 'The Foundation', description: 'Squat 100kg.', icon: 'fa-mountain', target: 100, progress: (s) => s.lifts['Squat'] ? s.lifts['Squat'].weight : 0 },
                { id: 'squat_120', name: 'Heavy Hitter', description: 'Squat 120kg.', icon: 'fa-gavel', target: 120, progress: (s) => s.lifts['Squat'] ? s.lifts['Squat'].weight : 0 },
                { id: 'squat_140', name: 'Beast of the Deep', description: 'Squat 140kg.', icon: 'fa-gavel', target: 140, progress: (s) => s.lifts['Squat'] ? s.lifts['Squat'].weight : 0 },
                { id: 'squat_160', name: 'Mountain Mover', description: 'Squat 160kg.', icon: 'fa-meteor', target: 160, progress: (s) => s.lifts['Squat'] ? s.lifts['Squat'].weight : 0 },
                { id: 'squat_180', name: 'Earthshaker', description: 'Squat 180kg.', icon: 'fa-meteor', target: 180, progress: (s) => s.lifts['Squat'] ? s.lifts['Squat'].weight : 0 },
                { id: 'squat_200', name: 'Atlas', description: 'Squat 200kg.', icon: 'fa-globe-americas', target: 200, progress: (s) => s.lifts['Squat'] ? s.lifts['Squat'].weight : 0 },

                { id: 'bench_60', name: 'Getting Started', description: 'Bench Press 60kg.', icon: 'fa-gem', target: 60, progress: (s) => s.lifts['Bench Press'] ? s.lifts['Bench Press'].weight : 0 },
                { id: 'bench_80', name: 'Serious Presser', description: 'Bench Press 80kg.', icon: 'fa-dumbbell', target: 80, progress: (s) => s.lifts['Bench Press'] ? s.lifts['Bench Press'].weight : 0 },
                { id: 'bench_100', name: 'The Centurion', description: 'Bench Press 100kg.', icon: 'fa-gem', target: 100, progress: (s) => s.lifts['Bench Press'] ? s.lifts['Bench Press'].weight : 0 },
                { id: 'bench_120', name: 'Titan\'s Chest', description: 'Bench Press 120kg.', icon: 'fa-dumbbell', target: 120, progress: (s) => s.lifts['Bench Press'] ? s.lifts['Bench Press'].weight : 0 },
                { id: 'bench_140', name: 'Forge Breaker', description: 'Bench Press 140kg.', icon: 'fa-hammer', target: 140, progress: (s) => s.lifts['Bench Press'] ? s.lifts['Bench Press'].weight : 0 },

                { id: 'deadlift_100', name: 'Ground Breaker', description: 'Deadlift 100kg.', icon: 'fa-rocket', target: 100, progress: (s) => s.lifts['Deadlift'] ? s.lifts['Deadlift'].weight : 0 },
                { id: 'deadlift_140', name: 'Gravity\'s Foe', description: 'Deadlift 140kg.', icon: 'fa-anchor', target: 140, progress: (s) => s.lifts['Deadlift'] ? s.lifts['Deadlift'].weight : 0 },
                { id: 'deadlift_180', name: 'World Breaker', description: 'Deadlift 180kg.', icon: 'fa-rocket', target: 180, progress: (s) => s.lifts['Deadlift'] ? s.lifts['Deadlift'].weight : 0 },
                { id: 'deadlift_200', name: 'The Unmovable', description: 'Deadlift 200kg.', icon: 'fa-anchor', target: 200, progress: (s) => s.lifts['Deadlift'] ? s.lifts['Deadlift'].weight : 0 },
                { id: 'deadlift_220', name: 'Anti-Gravity', description: 'Deadlift 220kg.', icon: 'fa-rocket', target: 220, progress: (s) => s.lifts['Deadlift'] ? s.lifts['Deadlift'].weight : 0 },
                { id: 'deadlift_250', name: 'Quake Starter', description: 'Deadlift 250kg.', icon: 'fa-volcano', target: 250, progress: (s) => s.lifts['Deadlift'] ? s.lifts['Deadlift'].weight : 0 },

                { id: 'ohp_40', name: 'Shoulder Boulder', description: 'Overhead Press 40kg.', icon: 'fa-arrow-up', target: 40, progress: (s) => s.lifts['Overhead Press'] ? s.lifts['Overhead Press'].weight : 0 },
                { id: 'ohp_60', name: 'Skyward Press', description: 'Overhead Press 60kg.', icon: 'fa-arrow-up', target: 60, progress: (s) => s.lifts['Overhead Press'] ? s.lifts['Overhead Press'].weight : 0 },
                { id: 'ohp_80', name: 'Cloud Piercer', description: 'Overhead Press 80kg.', icon: 'fa-cloud-upload-alt', target: 80, progress: (s) => s.lifts['Overhead Press'] ? s.lifts['Overhead Press'].weight : 0 },
                { id: 'ohp_100', name: 'Star Destroyer', description: 'Overhead Press 100kg.', icon: 'fa-star', target: 100, progress: (s) => s.lifts['Overhead Press'] ? s.lifts['Overhead Press'].weight : 0 },

                { id: 'row_60', name: 'First Pulls', description: 'Barbell Row 60kg.', icon: 'fa-water', target: 60, progress: (s) => s.lifts['Barbell Row'] ? s.lifts['Barbell Row'].weight : 0 },
                { id: 'row_80', name: 'Strong Back', description: 'Barbell Row 80kg.', icon: 'fa-water', target: 80, progress: (s) => s.lifts['Barbell Row'] ? s.lifts['Barbell Row'].weight : 0 },
                { id: 'row_100', name: 'Cobra Back', description: 'Barbell Row 100kg.', icon: 'fa-staff-snake', target: 100, progress: (s) => s.lifts['Barbell Row'] ? s.lifts['Barbell Row'].weight : 0 },

                { id: 'legpress_100', name: 'Leg Press Novice', description: 'Leg Press 100kg.', icon: 'fa-person-booth', target: 100, progress: (s) => s.lifts['Leg Press'] ? s.lifts['Leg Press'].weight : 0 },
                { id: 'legpress_150', name: 'Leg Press Apprentice', description: 'Leg Press 150kg.', icon: 'fa-person-booth', target: 150, progress: (s) => s.lifts['Leg Press'] ? s.lifts['Leg Press'].weight : 0 },
                { id: 'legpress_200', name: 'Leg Press Journeyman', description: 'Leg Press 200kg.', icon: 'fa-person-booth', target: 200, progress: (s) => s.lifts['Leg Press'] ? s.lifts['Leg Press'].weight : 0 },
                { id: 'legpress_250', name: 'Leg Press Master', description: 'Leg Press 250kg.', icon: 'fa-person-booth', target: 250, progress: (s) => s.lifts['Leg Press'] ? s.lifts['Leg Press'].weight : 0 },

                { id: 'latpulldown_50', name: 'Wing Sprouter', description: 'Lat Pulldown 50kg.', icon: 'fa-feather', target: 50, progress: (s) => s.lifts['Lat Pulldown'] ? s.lifts['Lat Pulldown'].weight : 0 },
                { id: 'latpulldown_70', name: 'Getting Wide', description: 'Lat Pulldown 70kg.', icon: 'fa-feather-alt', target: 70, progress: (s) => s.lifts['Lat Pulldown'] ? s.lifts['Lat Pulldown'].weight : 0 },
                { id: 'latpulldown_90', name: 'Demon Back', description: 'Lat Pulldown 90kg.', icon: 'fa-dragon', target: 90, progress: (s) => s.lifts['Lat Pulldown'] ? s.lifts['Lat Pulldown'].weight : 0 },

                { id: 'curl_15', name: 'Curl Novice', description: 'Dumbbell Curl 15kg.', icon: 'fa-child', target: 15, progress: (s) => s.lifts['Bicep Curl'] ? s.lifts['Bicep Curl'].weight : 0 },
                { id: 'curl_20', name: 'Python Arms', description: 'Dumbbell Curl 20kg.', icon: 'fa-child-reaching', target: 20, progress: (s) => s.lifts['Bicep Curl'] ? s.lifts['Bicep Curl'].weight : 0 },
                { id: 'curl_25', name: 'Mountain Peaks', description: 'Dumbbell Curl 25kg.', icon: 'fa-mountain-city', target: 25, progress: (s) => s.lifts['Bicep Curl'] ? s.lifts['Bicep Curl'].weight : 0 },

                { id: 'pclean_50', name: 'Explosive Start', description: 'Power Clean 50kg.', icon: 'fa-bolt', target: 50, progress: (s) => s.lifts['Power Clean'] ? s.lifts['Power Clean'].weight : 0 },
                { id: 'pclean_70', name: 'Powerhouse', description: 'Power Clean 70kg.', icon: 'fa-bolt-lightning', target: 70, progress: (s) => s.lifts['Power Clean'] ? s.lifts['Power Clean'].weight : 0 },
                { id: 'pclean_90', name: 'Human Catapult', description: 'Power Clean 90kg.', icon: 'fa-bomb', target: 90, progress: (s) => s.lifts['Power Clean'] ? s.lifts['Power Clean'].weight : 0 },

                // Dungeon & Gate Milestones
                { id: 'dungeons_5', name: 'Dungeon Explorer', description: 'Clear 5 Dungeons.', icon: 'fa-dungeon', target: 5, progress: (s) => s.stats.dungeonsCleared },
                { id: 'dungeons_10', name: 'Dungeon Crawler', description: 'Clear 10 Dungeons.', icon: 'fa-dungeon', target: 10, progress: (s) => s.stats.dungeonsCleared },
                { id: 'dungeons_25', name: 'Dungeon Veteran', description: 'Clear 25 Dungeons.', icon: 'fa-chess-king', target: 25, progress: (s) => s.stats.dungeonsCleared },
                { id: 'dungeons_50', name: 'Dungeon Conqueror', description: 'Clear 50 Dungeons.', icon: 'fa-chess-king', target: 50, progress: (s) => s.stats.dungeonsCleared },
                { id: 'dungeons_75', name: 'Dungeon Legend', description: 'Clear 75 Dungeons.', icon: 'fa-crown', target: 75, progress: (s) => s.stats.dungeonsCleared },
                { id: 'dungeons_100', name: 'Dungeon Master', description: 'Clear 100 Dungeons.', icon: 'fa-crown', target: 100, progress: (s) => s.stats.dungeonsCleared },
                { id: 'dungeons_150', name: 'Dungeon God', description: 'Clear 150 Dungeons.', icon: 'fa-hat-wizard', target: 150, progress: (s) => s.stats.dungeonsCleared },
                { id: 'dungeons_200', name: 'Living Anomaly', description: 'Clear 200 Dungeons.', icon: 'fa-infinity', target: 200, progress: (s) => s.stats.dungeonsCleared },

                { id: 'gates_5', name: 'Gate Runner', description: 'Clear 5 Gates.', icon: 'fa-door-open', target: 5, progress: (s) => s.stats.gatesCleared },
                { id: 'gates_10', name: 'Gate Breaker', description: 'Clear 10 Gates.', icon: 'fa-door-open', target: 10, progress: (s) => s.stats.gatesCleared },
                { id: 'gates_25', name: 'Gatekeeper', description: 'Clear 25 Gates.', icon: 'fa-door-open', target: 25, progress: (s) => s.stats.gatesCleared },
                { id: 'gates_50', name: 'Gate Warden', description: 'Clear 50 Gates.', icon: 'fa-door-closed', target: 50, progress: (s) => s.stats.gatesCleared },
                { id: 'gates_75', name: 'Gate Sentinel', description: 'Clear 75 Gates.', icon: 'fa-shield-halberd', target: 75, progress: (s) => s.stats.gatesCleared },
                { id: 'gates_100', name: 'Master of the Rift', description: 'Clear 100 Gates.', icon: 'fa-torii-gate', target: 100, progress: (s) => s.stats.gatesCleared },
                { id: 'gates_150', name: 'Dimension Walker', description: 'Clear 150 Gates.', icon: 'fa-satellite', target: 150, progress: (s) => s.stats.gatesCleared },

                { id: 'gate_e_rank', name: 'Gate Novice', description: 'Clear your first E-Rank Gate.', icon: 'fa-dungeon', target: 1, progress: (s) => s.stats.eRanksCleared },
                { id: 'gate_e_rank_5', name: 'E-Rank Specialist', description: 'Clear 5 E-Rank Gates.', icon: 'fa-dungeon', target: 5, progress: (s) => s.stats.eRanksCleared },
                { id: 'gate_e_rank_10', name: 'E-Rank Master', description: 'Clear 10 E-Rank Gates.', icon: 'fa-dungeon', target: 10, progress: (s) => s.stats.eRanksCleared },
                { id: 'gate_d_rank', name: 'D-Rank Hunter', description: 'Clear your first D-Rank Gate.', icon: 'fa-door-open', target: 1, progress: (s) => s.stats.dRanksCleared },
                { id: 'gate_d_rank_5', name: 'D-Rank Specialist', description: 'Clear 5 D-Rank Gates.', icon: 'fa-door-open', target: 5, progress: (s) => s.stats.dRanksCleared },
                { id: 'gate_d_rank_10', name: 'D-Rank Master', description: 'Clear 10 D-Rank Gates.', icon: 'fa-door-open', target: 10, progress: (s) => s.stats.dRanksCleared },
                { id: 'gate_c_rank', name: 'C-Rank Hunter', description: 'Clear your first C-Rank Gate.', icon: 'fa-door-open', target: 1, progress: (s) => s.stats.cRanksCleared },
                { id: 'gate_c_rank_5', name: 'C-Rank Specialist', description: 'Clear 5 C-Rank Gates.', icon: 'fa-door-open', target: 5, progress: (s) => s.stats.cRanksCleared },
                { id: 'gate_c_rank_10', name: 'C-Rank Master', description: 'Clear 10 C-Rank Gates.', icon: 'fa-door-open', target: 10, progress: (s) => s.stats.cRanksCleared },
                { id: 'gate_b_rank', name: 'B-Rank Hunter', description: 'Clear your first B-Rank Gate.', icon: 'fa-shield-halberd', target: 1, progress: (s) => s.stats.bRanksCleared },
                { id: 'gate_b_rank_5', name: 'B-Rank Specialist', description: 'Clear 5 B-Rank Gates.', icon: 'fa-shield-halberd', target: 5, progress: (s) => s.stats.bRanksCleared },
                { id: 'gate_b_rank_10', name: 'B-Rank Master', description: 'Clear 10 B-Rank Gates.', icon: 'fa-shield-halberd', target: 10, progress: (s) => s.stats.bRanksCleared },
                { id: 'gate_a_rank', name: 'A-Rank Hunter', description: 'Clear your first A-Rank Gate.', icon: 'fa-skull', target: 1, progress: (s) => s.stats.aRanksCleared },
                { id: 'gate_a_rank_5', name: 'A-Rank Specialist', description: 'Clear 5 A-Rank Gates.', icon: 'fa-skull', target: 5, progress: (s) => s.stats.aRanksCleared },
                { id: 'gate_a_rank_10', name: 'A-Rank Master', description: 'Clear 10 A-Rank Gates.', icon: 'fa-skull', target: 10, progress: (s) => s.stats.aRanksCleared },
                { id: 's_rank_gate', name: 'S-Rank Hunter', description: 'Clear your first S-Rank Gate.', icon: 'fa-skull-crossbones', target: 1, progress: (s) => s.stats.sRanksCleared },
                { id: 's_rank_3', name: 'S-Rank Veteran', description: 'Clear 3 S-Rank Gates.', icon: 'fa-skull-crossbones', target: 3, progress: (s) => s.stats.sRanksCleared },
                { id: 's_rank_5', name: 'S-Rank Elite', description: 'Clear 5 S-Rank Gates.', icon: 'fa-skull-crossbones', target: 5, progress: (s) => s.stats.sRanksCleared },
                { id: 's_rank_10', name: 'National Level', description: 'Clear 10 S-Rank Gates.', icon: 'fa-skull', target: 10, progress: (s) => s.stats.sRanksCleared },

                // Consistency & Volume
                { id: 'streak_7', name: 'Weekly Warrior', description: 'Maintain a 7-day workout streak.', icon: 'fa-fire', target: 7, progress: (s) => s.streak },
                { id: 'streak_14', name: 'Fortnightly Fighter', description: 'Maintain a 14-day workout streak.', icon: 'fa-fire', target: 14, progress: (s) => s.streak },
                { id: 'streak_30', name: 'Iron Will', description: 'Maintain a 30-day workout streak.', icon: 'fa-fire', target: 30, progress: (s) => s.streak },
                { id: 'streak_60', name: 'Two-Month Titan', description: 'Maintain a 60-day workout streak.', icon: 'fa-fire-alt', target: 60, progress: (s) => s.streak },
                { id: 'streak_90', name: 'Quarterly King', description: 'Maintain a 90-day workout streak.', icon: 'fa-fire-alt', target: 90, progress: (s) => s.streak },
                { id: 'streak_100', name: 'Unbreakable', description: 'Maintain a 100-day workout streak.', icon: 'fa-fire-flame-curved', target: 100, progress: (s) => s.streak },
                { id: 'streak_180', name: 'Half-Year Hero', description: 'Maintain a 180-day workout streak.', icon: 'fa-fire-flame-curved', target: 180, progress: (s) => s.streak },
                { id: 'streak_365', name: 'Monarch of Consistency', description: 'Maintain a 365-day workout streak.', icon: 'fa-calendar-check', target: 365, progress: (s) => s.streak },

                { id: 'workouts_10', name: 'Getting Started', description: 'Complete 10 total workouts.', icon: 'fa-medal', target: 10, progress: (s) => s.stats.totalWorkouts },
                { id: 'workouts_25', name: 'Regular', description: 'Complete 25 total workouts.', icon: 'fa-medal', target: 25, progress: (s) => s.stats.totalWorkouts },
                { id: 'workouts_50', name: 'Habitual', description: 'Complete 50 total workouts.', icon: 'fa-medal', target: 50, progress: (s) => s.stats.totalWorkouts },
                { id: 'workouts_75', name: 'Committed', description: 'Complete 75 total workouts.', icon: 'fa-trophy', target: 75, progress: (s) => s.stats.totalWorkouts },
                { id: 'workouts_100', name: 'Veteran Hunter', description: 'Complete 100 total workouts.', icon: 'fa-trophy', target: 100, progress: (s) => s.stats.totalWorkouts },
                { id: 'workouts_150', name: 'Elite Hunter', description: 'Complete 150 total workouts.', icon: 'fa-trophy', target: 150, progress: (s) => s.stats.totalWorkouts },
                { id: 'workouts_250', name: 'Master Hunter', description: 'Complete 250 total workouts.', icon: 'fa-award', target: 250, progress: (s) => s.stats.totalWorkouts },
                { id: 'workouts_350', name: 'Grandmaster Hunter', description: 'Complete 350 total workouts.', icon: 'fa-award', target: 350, progress: (s) => s.stats.totalWorkouts },
                { id: 'workouts_500', name: 'Shadow General', description: 'Complete 500 total workouts.', icon: 'fa-star-of-life', target: 500, progress: (s) => s.stats.totalWorkouts },

                { id: 'phase1_complete', name: 'Foundations Built', description: 'Complete Phase 1 of the program (12 weeks).', icon: 'fa-university', target: 12, progress: (s) => s.week },
                { id: 'phase2_complete', name: 'Hypertrophy Honed', description: 'Complete Phase 2 of the program (24 weeks).', icon: 'fa-building-columns', target: 24, progress: (s) => s.week },
                { id: 'phase3_complete', name: 'Power Unleashed', description: 'Complete Phase 3 of the program (36 weeks).', icon: 'fa-bolt-lightning', target: 36, progress: (s) => s.week },
                { id: 'phase4_complete', name: 'Peak Performer', description: 'Complete Phase 4 of the program (48 weeks).', icon: 'fa-rocket', target: 48, progress: (s) => s.week },

                { id: 'volume_100k', name: 'Hundred Thousand Kilos', description: 'Lift a total of 100,000 kg.', icon: 'fa-weight-hanging', target: 100000, progress: (s) => s.stats.totalVolumeKg },
                { id: 'volume_250k', name: 'Quarter Million Kilos', description: 'Lift a total of 250,000 kg.', icon: 'fa-weight-hanging', target: 250000, progress: (s) => s.stats.totalVolumeKg },
                { id: 'volume_500k', name: 'Half Million Kilos', description: 'Lift a total of 500,000 kg.', icon: 'fa-weight-hanging', target: 500000, progress: (s) => s.stats.totalVolumeKg },
                { id: 'volume_750k', name: 'Three-Quarters Million Kilos', description: 'Lift a total of 750,000 kg.', icon: 'fa-weight-hanging', target: 750000, progress: (s) => s.stats.totalVolumeKg },
                { id: 'volume_1M', name: 'One Million Kilos', description: 'Lift a total of 1,000,000 kg.', icon: 'fa-weight-hanging', target: 1000000, progress: (s) => s.stats.totalVolumeKg },
                { id: 'volume_1.5M', name: '1.5 Million Kilos', description: 'Lift a total of 1,500,000 kg.', icon: 'fa-truck-moving', target: 1500000, progress: (s) => s.stats.totalVolumeKg },
                { id: 'volume_2M', name: 'Two Million Kilos', description: 'Lift a total of 2,000,000 kg.', icon: 'fa-truck-moving', target: 2000000, progress: (s) => s.stats.totalVolumeKg },
                { id: 'volume_5M', name: 'Five Million Kilos', description: 'Lift a total of 5,000,000 kg.', icon: 'fa-train', target: 5000000, progress: (s) => s.stats.totalVolumeKg },

                { id: 'session_volume_5k', name: 'Productive Session', description: 'Lift 5,000kg in a single session.', icon: 'fa-battery-half', target: 5000, progress: (s) => s.stats.maxVolumeInSession },
                { id: 'session_volume_10k', name: 'Hard Worker', description: 'Lift 10,000kg in a single session.', icon: 'fa-battery-full', target: 10000, progress: (s) => s.stats.maxVolumeInSession },
                { id: 'session_volume_15k', name: 'True Monarch', description: 'Lift 15,000kg in a single session.', icon: 'fa-battery-bolt', target: 15000, progress: (s) => s.stats.maxVolumeInSession },

                // Architect & Customization
                { id: 'avatar_set', name: 'The Real Me', description: 'Set a custom avatar.', icon: 'fa-camera', target: 1, progress: (s) => s.customAvatar ? 1 : 0 },
                { id: 'name_changed', name: 'What\'s in a Name?', description: 'Change your player name.', icon: 'fa-pencil-alt', target: 1, progress: (s) => s.playerName !== 'Player' ? 1 : 0 },
                { id: 'routine_created', name: 'My First Blueprint', description: 'Create your first custom routine.', icon: 'fa-ruler-combined', target: 1, progress: (s) => s.savedRoutines.length },
                { id: 'routine_5', name: 'Well-Oiled Machine', description: 'Save 5 custom routines.', icon: 'fa-cogs', target: 5, progress: (s) => s.savedRoutines.length },
                { id: 'routine_10', name: 'Master Architect', description: 'Save 10 custom routines.', icon: 'fa-drafting-compass', target: 10, progress: (s) => s.savedRoutines.length },

                // Collection & Completion
                { id: 'all_gates', name: 'Gate Collector', description: 'Clear one of every rank of gate (E-S).', icon: 'fa-gem', target: 6, progress: (s) => (s.stats.eRanksCleared > 0) + (s.stats.dRanksCleared > 0) + (s.stats.cRanksCleared > 0) + (s.stats.bRanksCleared > 0) + (s.stats.aRanksCleared > 0) + (s.stats.sRanksCleared > 0) },
                { id: 'strength_novice', name: 'Strength Novice', description: 'Reach 60kg on Squat, Bench, and Deadlift.', icon: 'fa-seedling', target: 3, progress: (s) => ((s.lifts['Squat'] ? s.lifts['Squat'].weight : 0) >= 60) + ((s.lifts['Bench Press'] ? s.lifts['Bench Press'].weight : 0) >= 60) + ((s.lifts['Deadlift'] ? s.lifts['Deadlift'].weight : 0) >= 60) },
                { id: 'strength_journeyman', name: 'Strength Journeyman', description: 'Reach 100kg Squat, 80kg Bench, 140kg Deadlift.', icon: 'fa-hammer', target: 3, progress: (s) => ((s.lifts['Squat'] ? s.lifts['Squat'].weight : 0) >= 100) + ((s.lifts['Bench Press'] ? s.lifts['Bench Press'].weight : 0) >= 80) + ((s.lifts['Deadlift'] ? s.lifts['Deadlift'].weight : 0) >= 140) },
                { id: 'strength_master', name: 'Strength Master', description: 'Reach 140kg Squat, 100kg Bench, 180kg Deadlift.', icon: 'fa-crown', target: 3, progress: (s) => ((s.lifts['Squat'] ? s.lifts['Squat'].weight : 0) >= 140) + ((s.lifts['Bench Press'] ? s.lifts['Bench Press'].weight : 0) >= 100) + ((s.lifts['Deadlift'] ? s.lifts['Deadlift'].weight : 0) >= 180) },
                { id: '1000lb_club', name: 'The 1000lb Club', description: 'Total of Squat, Bench, and Deadlift exceeds 453.6kg.', icon: 'fa-weight-scale', target: 453.6, progress: (s) => (s.lifts['Squat'] ? s.lifts['Squat'].weight : 0) + (s.lifts['Bench Press'] ? s.lifts['Bench Press'].weight : 0) + (s.lifts['Deadlift'] ? s.lifts['Deadlift'].weight : 0) },
            ],

            // --- CORE LIFECYCLE ---
            init() {
                if (this.state.isInitialized) return;
                console.log("App Initializing...");
                this.loadData().then(() => {
                    this.generateGate();
                    this.render();
                    this.bindEvents();
                    this.state.isInitialized = true;
                    console.log("App Initialized Successfully.");
                });
            },

            async loadData() {
                if (!this.state.user) return;
                const userRef = doc(db, "users", this.state.user.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    Object.assign(this.state, data);
                } else {
                    await this.saveData();
                }
            },

            async saveData() {
                if (!this.state.user) return;
                const userRef = doc(db, "users", this.state.user.uid);
                try {
                    const stateToSave = { ...this.state };
                    delete stateToSave.user;
                    await setDoc(userRef, stateToSave, { merge: true });
                    console.log("Data saved to Firestore.");
                } catch (error) {
                    console.error("Error saving data:", error);
                    alert("Error saving progress to the cloud.");
                }
            },

            // --- EVENT BINDING ---
            bindEvents() {
                console.log("Binding delegated events...");
                // Global event delegation
                document.body.addEventListener('click', (e) => {
                    const target = e.target.closest('[data-action]');
                    if (!target) return;
                    const action = target.getAttribute('data-action');
                    if (this.actions[action]) {
                        e.preventDefault();
                        const value = target.getAttribute('data-value');
                        if (value !== null) {
                            this.actions[action](value);
                        } else {
                            this.actions[action](e, target);
                        }
                    }
                });
                // Direct inputs
                document.getElementById('avatar-container').addEventListener('click', () => document.getElementById('avatar-upload-input').click());
                document.getElementById('avatar-upload-input').addEventListener('change', (e) => this.handleAvatarUpload(e));
                document.getElementById('architect-routine-name').addEventListener('input', (e) => this.handleRoutineNameInput(e));
                console.log("Delegated events ready.");
            },
            actions: {
                'nav:dashboard': (e, el) => app.showPage('dashboard'),
                'nav:workout': (e, el) => app.showPage('workout'),
                'nav:gates': (e, el) => app.showPage('gates'),
                'nav:architect': (e, el) => app.showPage('architect'),
                'nav:achievements': (e, el) => app.showPage('achievements'),
                'nav:settings': (e, el) => app.showPage('settings'),
                'player:editName': () => app.editPlayerName(),
                'player:selectShowcase': () => app.openShowcaseSelector(),
                'workout:preview': () => app.previewQuest(),
                'workout:begin': () => app.beginQuest(),
                'gate:complete': () => app.completeGate(),
                'gates:open': (e, el) => app.completeGate(e, el.getAttribute('data-gate-id')),
                'settings:delete': () => app.confirmDeleteAccount(),
                'nextDungeonTask': () => app.nextDungeonTask(),
                'cancelDungeon': () => app.cancelDungeon(),
                'completeDungeon': () => app.completeDungeon(),
                selectDifficulty(difficulty) {
                    this.state.difficulty = difficulty;
                    this.saveData();
                    document.getElementById('difficulty-options').classList.add('hidden');
                    this.renderSettingsPage();
                },
                selectArchitectExercise(exercise) {
                    this.state.currentArchitectExercise = exercise;
                    document.getElementById('architect-exercise-options').classList.add('hidden');
                    this.populateExerciseDropdown();
                },
                toggleDropdown(optionsId) {
                    document.getElementById(optionsId).classList.toggle('hidden');
                },
                selectMonth(monthIndex) {
                    const newDate = new Date(this.state.calendar.viewDate);
                    newDate.setMonth(parseInt(monthIndex));
                    this.state.calendar.viewDate = newDate;
                    document.getElementById('month-options').classList.add('hidden');
                    this.renderActivityCalendar();
                },
                selectYear(year) {
                    const newDate = new Date(this.state.calendar.viewDate);
                    newDate.setFullYear(parseInt(year));
                    this.state.calendar.viewDate = newDate;
                    document.getElementById('year-options').classList.add('hidden');
                    this.renderActivityCalendar();
                },
            },

            createCustomDropdown({ containerSelector, currentValue, options, actionName, optionsId, widthClass = 'w-full' }) {
                const container = document.querySelector(containerSelector);
                if (!container) return;

                let optionsHtml = options.map(opt =>
                    `<div class="custom-select-option" data-action="${actionName}" data-value="${opt.value}">${opt.label}</div>`
                ).join('');

                const currentOption = options.find(opt => opt.value == currentValue);
                const currentLabel = currentOption ? currentOption.label : 'Select...';

                container.innerHTML = `
                    <div class="custom-select-container ${widthClass}">
                        <div class="custom-select-value" data-action="toggleDropdown" data-value="${optionsId}">
                            <span>${currentLabel}</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                        <div id="${optionsId}" class="custom-select-options hidden">${optionsHtml}</div>
                    </div>
                `;
            },

            // --- UI & RENDERING ---
            render() {
                this.renderDashboard();
                this.renderArchitect();
                this.renderWorkoutPage();
                this.renderAchievementsPage();
                this.renderGatesPage();
                this.renderSettingsPage();
            },

            renderSettingsPage() {
                const difficultyOptions = [
                    { value: 'Easy', label: 'Easy' },
                    { value: 'Normal', label: 'Normal' },
                    { value: 'Hard', label: 'Hard' }
                ];
                this.createCustomDropdown({
                    containerSelector: '#difficulty-dropdown-container',
                    currentValue: this.state.difficulty,
                    options: difficultyOptions,
                    actionName: 'selectDifficulty',
                    optionsId: 'difficulty-options'
                });
            },

            renderDashboard() {
                document.getElementById('player-name-display').textContent = this.state.playerName;
                const avatarImg = document.getElementById('dashboard-avatar-img');
                const avatarPlaceholder = document.getElementById('avatar-placeholder');
                if (this.state.customAvatar) {
                    avatarImg.src = this.state.customAvatar;
                    avatarImg.classList.remove('hidden');
                    avatarPlaceholder.classList.add('hidden');
                } else {
                    avatarImg.classList.add('hidden');
                    avatarPlaceholder.classList.remove('hidden');
                }
                
                const achievementsGrid = document.getElementById('achievements-grid');
                achievementsGrid.innerHTML = '';
                const unlocked = this.achievementsData.filter(ach => this.state.achievements.includes(ach.id));
                if (unlocked.length > 0) {
                    unlocked.forEach(ach => {
                        const div = document.createElement('div');
                        div.className = 'p-4 bg-gray-800 rounded-lg text-center';
                        div.innerHTML = `<i class="fas ${ach.icon} text-3xl text-indigo-400 mb-2"></i><p class="font-semibold">${ach.name}</p>`;
                        achievementsGrid.appendChild(div);
                    });
                } else {
                    achievementsGrid.innerHTML = '<p class="text-gray-400 col-span-full">Your legend has yet to be written. Complete quests to earn achievements.</p>';
                }
                // Stats
                const lvlEl = document.getElementById('stat-level');
                const xpEl = document.getElementById('stat-xp');
                const manaEl = document.getElementById('stat-mana');
                const streakEl = document.getElementById('stat-streak');
                const workoutsEl = document.getElementById('stat-workouts');
                const xpBar = document.getElementById('xp-bar');
                if (lvlEl) lvlEl.textContent = this.state.level;
                if (xpEl) xpEl.textContent = `${this.state.xp} / ${this.state.xpToNextLevel} XP`;
                if (manaEl) manaEl.textContent = this.state.mana;
                if (streakEl) streakEl.textContent = this.state.streak;
                if (workoutsEl) workoutsEl.textContent = this.state.stats.totalWorkouts;
                if (xpBar) xpBar.style.width = `${Math.min(100, Math.round((this.state.xp / this.state.xpToNextLevel) * 100))}%`;
                // Player card mirrors
                const pcLevel = document.getElementById('pc-level');
                const pcStreak = document.getElementById('pc-streak');
                const pcLongest = document.getElementById('pc-longest');
                if (pcLevel) pcLevel.textContent = this.state.level;
                if (pcStreak) pcStreak.textContent = this.state.streak;
                if (pcLongest) pcLongest.textContent = this.state.longestStreak || 0;
                // Radar chart
                this.renderRadarChart();
                // Showcase
                this.renderShowcase();
                this.renderActivityCalendar();
            },

            renderActivityCalendar() {
                const container = document.getElementById('activity-calendar-container');
                if (!container) return;

                // Main container structure
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Activity Log</h3>
                        <div class="flex gap-2">
                            <div id="month-dropdown-container"></div>
                            <div id="year-dropdown-container"></div>
                        </div>
                    </div>
                    <div id="calendar-header" class="grid grid-cols-7 text-center text-xs text-stone-400 mb-2">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1.5"></div>
                `;

                const viewDate = new Date(this.state.calendar.viewDate);
                const month = viewDate.getMonth();
                const year = viewDate.getFullYear();

                // Create month dropdown
                const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                const monthOptions = months.map((m, i) => ({ value: i, label: m }));
                this.createCustomDropdown({
                    containerSelector: '#month-dropdown-container',
                    currentValue: month,
                    options: monthOptions,
                    actionName: 'selectMonth',
                    optionsId: 'month-options',
                    widthClass: 'w-32'
                });

                // Create year dropdown
                const currentYear = new Date().getFullYear();
                const yearOptions = [];
                for (let y = currentYear; y >= currentYear - 5; y--) {
                    yearOptions.push({ value: y, label: y });
                }
                this.createCustomDropdown({
                    containerSelector: '#year-dropdown-container',
                    currentValue: year,
                    options: yearOptions,
                    actionName: 'selectYear',
                    optionsId: 'year-options',
                    widthClass: 'w-24'
                });

                // Calendar grid rendering logic
                const grid = document.getElementById('calendar-grid');
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDayOfMonth; i++) { grid.appendChild(document.createElement('div')); }
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateString = date.toISOString().split('T')[0];
                    const daySquare = document.createElement('div');
                    daySquare.className = 'w-full aspect-square rounded bg-stone-700/50 p-1 flex flex-col items-start';
                    daySquare.innerHTML = `<span class="text-xs text-stone-400">${day}</span>`;
                    const activities = this.state.activityLog.filter(log => log.date === dateString);
                    if (activities.length > 0) {
                        const indicator = document.createElement('div');
                        indicator.className = 'w-full h-full flex items-center justify-center';
                        if (activities.some(a => a.type === 'workout')) indicator.innerHTML += '<i class="fas fa-dumbbell text-indigo-400 text-xs"></i>';
                        if (activities.some(a => a.type === 'gate')) indicator.innerHTML += '<i class="fas fa-door-open text-amber-400 text-xs ml-1"></i>';
                        daySquare.appendChild(indicator);
                    }
                    grid.appendChild(daySquare);
                }
            },
            
            renderArchitect() {
                const previewContainer = document.getElementById('architect-routine-preview');
                previewContainer.innerHTML = '';
                 if(this.state.currentCustomWorkout.exercises.length > 0){
                    const title = document.createElement('h4');
                    title.textContent = "Routine Preview:";
                    title.className = "font-bold text-lg";
                    previewContainer.appendChild(title);
                }
                this.state.currentCustomWorkout.exercises.forEach((ex, index) => {
                    const p = document.createElement('div');
                    p.className = 'p-2 bg-gray-800 rounded flex justify-between items-center';
                    p.innerHTML = `<span>${ex.name}: ${ex.sets} sets of ${ex.reps} reps</span><button data-index="${index}" class="remove-exercise-btn text-red-500 hover:text-red-400"></button>`;
                    previewContainer.appendChild(p);
                });
                
                document.querySelectorAll('.remove-exercise-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        this.removeExerciseFromRoutine(index);
                    });
                });

                const saveBtn = document.getElementById('architect-save-routine-btn');
                if(this.state.currentCustomWorkout.name && this.state.currentCustomWorkout.exercises.length > 0){
                    saveBtn.classList.remove('hidden');
                } else {
                    saveBtn.classList.add('hidden');
                }
            },
            renderRadarChart() {
                const ctx = document.getElementById('radar-chart');
                if (!ctx) return;
                const pillars = ['Upper Body Push', 'Upper Body Pull', 'Leg Strength', 'Core', 'Power'];
                const get = (name) => (this.state.lifts[name] ? this.state.lifts[name].weight : 0);
                const push = (get('Bench Press') * 0.7 + get('Overhead Press') * 0.3);
                const pull = (get('Barbell Row') * 0.6 + get('Lat Pulldown') * 0.4);
                const legs = (get('Squat') * 0.7 + get('Deadlift') * 0.3);
                const core = (get('Romanian Deadlift') * 0.5 + get('Leg Press') * 0.5); // proxy
                const power = (get('Power Clean') * 0.7 + get('Box Jump') * 0.3);
                const data = [push, pull, legs, core, power].map(v => Math.round(v));
                if (this._radarChart) {
                    this._radarChart.data.datasets[0].data = data;
                    this._radarChart.update();
                } else {
                    this._radarChart = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: pillars,
                            datasets: [{ label: 'Strength Pillars', data, backgroundColor: 'rgba(99,102,241,0.2)', borderColor: '#6366f1', pointBackgroundColor: '#a5b4fc' }]
                        },
                        options: { scales: { r: { angleLines: { color: '#374151' }, grid: { color: '#374151' }, pointLabels: { color: '#e5e7eb' }, ticks: { display: false } } }, plugins: { legend: { labels: { color: '#e5e7eb' } } } }
                    });
                }
            },
            renderShowcase() {
                const wrap = document.getElementById('showcase-achievements');
                if (!wrap) return;
                wrap.innerHTML = '';
                const unlocked = this.achievementsData.filter(a => (this.state.achievements.includes(a.id) || a.progress(this.state) >= a.target));
                const toShow = (this.state.showcase && this.state.showcase.length ? this.state.showcase : unlocked.slice(0,3).map(a=>a.id)).slice(0,3);
                toShow.forEach(id => {
                    const a = this.achievementsData.find(x => x.id === id);
                    if (!a) return;
                    const div = document.createElement('div');
                    div.className = 'p-2 bg-gray-800 rounded text-center';
                    div.innerHTML = `<i class=\"fas ${a.icon} text-indigo-400\"></i>`;
                    wrap.appendChild(div);
                });
            },
            
            renderWorkoutPage() {
                const today = new Date().getDay();
                const dayIndex = today === 0 ? 6 : today - 1;
                const daySchedule = ['Push', 'Pull', 'Legs', 'Push', 'Pull', 'Legs', 'Rest'][dayIndex];
                
                const titleEl = document.getElementById('workout-day-title');
                const questBtns = document.getElementById('quest-buttons');
                const restMsg = document.getElementById('rest-day-message');

                if (daySchedule === 'Rest') {
                    titleEl.textContent = "Rest Day";
                    questBtns.classList.add('hidden');
                    restMsg.classList.remove('hidden');
                } else {
                    titleEl.textContent = `${daySchedule} Day`;
                    questBtns.classList.remove('hidden');
                    restMsg.classList.add('hidden');
                }

                const gateContainer = document.getElementById('gate-container');
                if (this.state.activeGate) {
                    document.getElementById('gate-description').textContent = `[${this.state.activeGate.rank}-Rank] ${this.state.activeGate.description}`;
                    gateContainer.classList.remove('hidden');
                } else {
                    gateContainer.classList.add('hidden');
                }
                // Periodically spawn gates
                if (!this._gateSpawnTimer) {
                    this._gateSpawnTimer = setInterval(() => this.generateGate(), 60 * 1000);
                }
            },

            // Gates Page Rendering and timers
            renderGatesPage() {
                const list = document.getElementById('gates-list');
                if (!list) return;
                const now = Date.now();
                const gates = (this.state.gates || []).filter(g => g.expiresAt > now);
                list.innerHTML = '';
                if (!gates.length) {
                    list.innerHTML = '<p class="text-gray-400">No active gates. Check back later.</p>';
                    return;
                }
                gates.forEach(g => {
                    const timeLeft = Math.max(0, g.expiresAt - Date.now());
                    const card = document.createElement('div');
                    card.className = 'p-4 bg-gray-800 rounded border border-gray-700';
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <p class="font-semibold">[${g.rank}-Rank] Gate</p>
                            <span class="text-xs px-2 py-1 rounded bg-gray-700" data-gate-ttl="${g.id}"></span>
                        </div>
                        <p class="text-sm text-gray-300 mb-3">${g.description}</p>
                        <button class="btn-primary py-1 px-3 rounded" data-action="gates:open" data-gate-id="${g.id}">Open</button>
                    `;
                    list.appendChild(card);
                    this._updateGateTtl(g.id, timeLeft);
                });
                if (!this._gateTimer) {
                    this._gateTimer = setInterval(() => {
                        (this.state.gates || []).forEach(g => this._updateGateTtl(g.id, Math.max(0, g.expiresAt - Date.now())));
                        // Clean and rerender when any expired
                        const before = (this.state.gates || []).length;
                        this.state.gates = (this.state.gates || []).filter(g => g.expiresAt > Date.now());
                        if (before !== this.state.gates.length) this.renderGatesPage();
                    }, 1000);
                }
            },
            _updateGateTtl(id, ms) {
                const el = document.querySelector(`[data-gate-ttl="${id}"]`);
                if (!el) return;
                const s = Math.floor(ms/1000); const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60); const sec = s%60;
                el.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
            },

            // --- MODAL SYSTEM ---
            showModal({ title = '', html = '', actions = [] } = {}) {
                const overlay = document.getElementById('modal-overlay');
                const titleEl = document.getElementById('modal-title');
                const bodyEl = document.getElementById('modal-body');
                const actionsEl = document.getElementById('modal-actions');
                titleEl.textContent = title;
                bodyEl.innerHTML = html;
                actionsEl.innerHTML = '';
                actions.forEach(a => {
                    const btn = document.createElement('button');
                    btn.className = `modal-btn ${a.primary ? 'primary' : ''} text-white py-2 px-4 rounded`;
                    btn.textContent = a.label;
                    btn.addEventListener('click', () => { if (a.onClick) a.onClick(); });
                    actionsEl.appendChild(btn);
                });
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                const close = () => { overlay.classList.add('hidden'); overlay.classList.remove('flex'); };
                document.getElementById('modal-close').onclick = close;
                return { close };
            },

            modalAlert(message, title = 'Notice') {
                return new Promise((resolve) => {
                    const instance = this.showModal({
                        title,
                        html: `<p class=\"text-gray-200\">${message}</p>`,
                        actions: [{ label: 'OK', primary: true, onClick: () => { instance.close(); resolve(); } }]
                    });
                });
            },

            modalConfirm(message, title = 'Confirm') {
                return new Promise((resolve) => {
                    const instance = this.showModal({
                        title,
                        html: `<p class=\"text-gray-200\">${message}</p>`,
                        actions: [
                            { label: 'Cancel', onClick: () => { instance.close(); resolve(false); } },
                            { label: 'Confirm', primary: true, onClick: () => { instance.close(); resolve(true); } }
                        ]
                    });
                });
            },

            modalPrompt({ title = 'Input Required', message = '', placeholder = '' }) {
                return new Promise((resolve) => {
                    const id = `prompt-${Date.now()}`;
                    const instance = this.showModal({
                        title,
                        html: `<p class=\"text-gray-300 mb-3\">${message}</p><input id=\"${id}\" class=\"w-full p-2 bg-gray-800 rounded border border-gray-700 focus:border-indigo-500 focus:ring-0\" placeholder=\"${placeholder}\">`,
                        actions: [
                            { label: 'Cancel', onClick: () => { instance.close(); resolve(null); } },
                            { label: 'Submit', primary: true, onClick: () => { const val = document.getElementById(id).value; instance.close(); resolve(val); } }
                        ]
                    });
                });
            },

            renderAchievementsPage() {
                const grid = document.querySelector('#achievements-page #achievements-grid');
                if (!grid) return;
                grid.innerHTML = '';

                this.achievementsData.forEach((ach) => {
                    const current = Math.max(0, Number(ach.progress(this.state) || 0));
                    const target = Math.max(1, Number(ach.target || 1));
                    const percentage = Math.min(100, Math.round((current / target) * 100));
                    const unlocked = this.state.achievements.includes(ach.id) || current >= target;

                    const card = document.createElement('div');
                    card.className = `p-4 bg-gray-800 rounded-lg ${unlocked ? '' : 'achievement-locked'}`;
                    const unit = ach.id.startsWith('squat_') || ach.id.startsWith('bench_') || ach.id.startsWith('deadlift_') ? 'kg' : '';

                    card.innerHTML = `
                        <div class="flex items-center gap-3 mb-2">
                            <i class="fas ${ach.icon} text-2xl ${unlocked ? 'text-indigo-400' : 'text-gray-500'}"></i>
                            <div>
                                <p class="font-semibold">${ach.name}</p>
                                <p class="text-sm text-gray-400">${unlocked ? ach.description : 'Locked'}</p>
                            </div>
                        </div>
                        <div class="progress-bar mb-2"><div class="progress-bar-inner" style="width:${percentage}%;"></div></div>
                        <p class="text-sm text-gray-300">${current} / ${target} ${unit}</p>
                    `;
                    grid.appendChild(card);
                });
            },

            showPage(pageId) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(`${pageId}-page`).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`.nav-btn[data-page="${pageId}"]`).classList.add('active');
                document.getElementById('header-title').textContent = pageId.charAt(0).toUpperCase() + pageId.slice(1);
                if(pageId === 'architect') this.populateExerciseDropdown();
                if(pageId === 'achievements') this.renderAchievementsPage();
                if(pageId === 'gates') this.renderGatesPage();
            },
            
            // --- ACTION HANDLERS ---
            editPlayerName() {
                this.modalPrompt({ title: 'Edit Name', message: 'Enter your new name:', placeholder: this.state.playerName }).then((val) => {
                    if (val && val.trim() !== '') {
                        this.state.playerName = val.trim();
                    this.saveData();
                    this.renderDashboard();
                }
                });
            },
            openShowcaseSelector() {
                const unlocked = this.achievementsData.filter(a => (this.state.achievements.includes(a.id) || a.progress(this.state) >= a.target));
                const id = `sc-${Date.now()}`;
                const grid = unlocked.map(a => `<label class=\"flex items-center gap-2 p-2 bg-gray-800 rounded\"><input type=\"checkbox\" value=\"${a.id}\" class=\"sc-cb\"><i class=\"fas ${a.icon} text-indigo-400\"></i><span>${a.name}</span></label>`).join('');
                const instance = this.showModal({
                    title: 'Select Showcase (max 3)',
                    html: `<div id=\"${id}\" class=\"space-y-2 max-h-64 overflow-auto\">${grid}</div>`,
                    actions: [
                        { label: 'Cancel', onClick: () => instance.close() },
                        { label: 'Save', primary: true, onClick: () => {
                            const selected = Array.from(document.querySelectorAll('#'+id+' .sc-cb:checked')).map(cb => cb.value).slice(0,3);
                            app.state.showcase = selected;
                            app.saveData();
                            app.renderShowcase();
                            instance.close();
                        } }
                    ]
                });
            },

            handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.state.customAvatar = e.target.result;
                    this.saveData();
                    this.renderDashboard();
                };
                reader.readAsDataURL(file);
            },
            
            handleRoutineNameInput(event) {
                const name = event.target.value.trim();
                const exerciseSection = document.getElementById('architect-exercise-section');
                if (name) {
                    this.state.currentCustomWorkout.name = name;
                    exerciseSection.classList.remove('hidden');
                } else {
                    exerciseSection.classList.add('hidden');
                }
                this.renderArchitect();
            },
            
            populateExerciseDropdown() {
                const exerciseOptions = this.masterExerciseList.map(ex => ({ value: ex, label: ex }));
                this.createCustomDropdown({
                    containerSelector: '#architect-exercise-dropdown-container',
                    currentValue: this.state.currentArchitectExercise,
                    options: exerciseOptions,
                    actionName: 'selectArchitectExercise',
                    optionsId: 'architect-exercise-options'
                });
            },

            addExerciseToRoutine() {
                const setsInput = document.getElementById('architect-sets');
                const repsInput = document.getElementById('architect-reps');

                if (this.state.currentArchitectExercise && setsInput.value && repsInput.value) {
                    this.state.currentCustomWorkout.exercises.push({ 
                        name: this.state.currentArchitectExercise,
                        sets: setsInput.value, 
                        reps: repsInput.value 
                    });
                    this.state.currentArchitectExercise = null; // Reset
                    this.populateExerciseDropdown(); // Re-render dropdown
                    this.renderArchitect(); // Re-render routine preview
                    setsInput.value = '';
                    repsInput.value = '';
                } else {
                    alert("Please fill out all exercise fields.");
                }
            },

            removeExerciseFromRoutine(index) {
                this.state.currentCustomWorkout.exercises.splice(index, 1);
                this.renderArchitect();
            },

            saveCurrentRoutine() {
                this.state.savedRoutines.push(this.state.currentCustomWorkout);
                this.saveData();
                this.modalAlert(`Routine "${this.state.currentCustomWorkout.name}" saved!`, 'Routine Saved');
                this.state.currentCustomWorkout = { name: '', exercises: [] };
                document.getElementById('architect-routine-name').value = '';
                document.getElementById('architect-exercise-section').classList.add('hidden');
                this.renderArchitect();
            },
            
            confirmDeleteAccount() {
                this.modalPrompt({ title: 'Confirm Deletion', message: `This action is permanent. Type your name to confirm: "${this.state.playerName}"`, placeholder: this.state.playerName }).then((val) => {
                    if (val === this.state.playerName) {
                    deleteDoc(doc(db, "users", this.state.user.uid)).then(() => {
                            this.modalAlert("Account deleted successfully.");
                        auth.signOut();
                    }).catch(error => {
                        console.error("Error deleting account:", error);
                            this.modalAlert("Could not delete account. Please try again.");
                    });
                    } else if (val !== null) {
                        this.modalAlert("Name does not match. Deletion cancelled.");
                }
                });
            },
            
            // --- WORKOUT & GATE FLOW ---
            getCurrentWorkout() {
                const phase = Math.min(4, Math.floor((this.state.week - 1) / 12) + 1);
                const today = new Date().getDay();
                const dayIndex = today === 0 ? 6 : today - 1;
                const dayType = ['Push', 'Pull', 'Legs', 'Push', 'Pull', 'Legs', 'Rest'][dayIndex];
                
                if (dayType === 'Rest') return null;

                return this.workoutProgram.find(w => w.phase === phase && w.type === dayType);
            },
            getExerciseDescription(name) {
                const desc = {
                    'Bench Press': 'Builds raw pushing strength and chest mass.',
                    'Overhead Press': 'Develops shoulder strength and stability.',
                    'Incline DB Press': 'Targets upper chest for hypertrophy.',
                    'Barbell Row': 'Builds back thickness and pulling power.',
                    'Lat Pulldown': 'Targets lats for width and strength.',
                    'Bicep Curl': 'Isolates the biceps for size.',
                    'Deadlift': 'Full-body pull to develop posterior chain strength.',
                    'Romanian Deadlift': 'Emphasizes hamstrings and glutes.',
                    'Squat': 'Foundation lift for total-leg strength.',
                    'Leg Press': 'Quad-dominant lower-body volume.',
                    'Hamstring Curl': 'Hamstring isolation for balance.',
                    'Box Jump': 'Power development and explosiveness.'
                };
                return desc[name] || 'Train with focus and perfect form.';
            },
            getExerciseMuscleImg(name) {
                const group = {
                    'Bench Press': 'Chest',
                    'Incline DB Press': 'Chest',
                    'Overhead Press': 'Shoulders',
                    'Barbell Row': 'Back',
                    'Lat Pulldown': 'Back',
                    'Bicep Curl': 'Arms',
                    'Deadlift': 'Posterior',
                    'Romanian Deadlift': 'Posterior',
                    'Squat': 'Legs',
                    'Leg Press': 'Legs',
                    'Hamstring Curl': 'Legs',
                    'Box Jump': 'Legs'
                };
                const label = encodeURIComponent(group[name] || 'Muscle');
                return `https://placehold.co/150x100/1c1917/e7e5e4?text=${label}`;
            },

            previewQuest() {
                const workout = this.getCurrentWorkout();
                if (!workout) return;
                let html = `<div class="space-y-3">
                    <p class="text-indigo-400 font-semibold">${workout.type} Day - Phase ${workout.phase}</p>
                    <div class="space-y-2">`;
                workout.exercises.forEach(ex => {
                    const w = this.state.lifts[ex.name] ? this.state.lifts[ex.name].weight : 'N/A';
                    html += `<div class=\"p-3 bg-gray-800 rounded\">
                        <div class=\"flex items-center justify-between\">
                            <span class=\"font-semibold\">${ex.name}</span>
                            <span class=\"text-sm text-gray-300\">${ex.sets} x ${ex.reps} @ ${w} kg</span>
                        </div>
                    </div>`;
                });
                html += `</div></div>`;
                const instance = this.showModal({
                    title: 'Quest Preview',
                    html,
                    actions: [
                        { label: 'Close', onClick: () => instance.close() },
                        { label: 'Begin Quest', primary: true, onClick: () => { instance.close(); this.beginQuest(); } }
                    ]
                });
            },

            beginQuest() {
                const workout = this.getCurrentWorkout();
                if (!workout) return;

                this.state.dungeon.isActive = true;
                this.state.dungeon.currentExerciseIndex = 0;
                this.state.dungeon.exercises = workout.exercises.map(ex => ({...ex, description: this.getExerciseDescription(ex.name), muscleImg: this.getExerciseMuscleImg(ex.name)}));
                
                // Show full-page dungeon overlay
                this.renderDungeon();
                document.getElementById('dungeon-overlay').classList.remove('hidden');
                document.getElementById('dungeon-overlay').classList.add('flex');
            },
            
            renderDungeon() {
                const content = document.getElementById('dungeon-content');
                if (!this.state.dungeon.isActive) {
                    content.innerHTML = '';
                    return;
                }

                const index = this.state.dungeon.currentExerciseIndex;
                const exercises = this.state.dungeon.exercises;

                if (index >= exercises.length) {
                    content.innerHTML = `
                        <div class="text-center">
                        <h2 class="text-3xl font-bold text-green-400 mb-4">Quest Complete!</h2>
                        <p class="mb-6">You have cleared the dungeon. Return to base to claim your rewards.</p>
                        <button data-action="completeDungeon" class="btn-primary py-2 px-4 rounded">Return to Base</button>
                        </div>
                    `;
                } else {
                    const ex = exercises[index];
                    const lift = this.state.lifts[ex.name];
                    const weight = lift ? lift.weight : 'N/A';

                    let setsHtml = '';
                    for (let i = 1; i <= ex.sets; i++) {
                        setsHtml += `<div class="flex items-center p-2 bg-stone-800 rounded-md">
                            <input id="set-${i}" type="checkbox" class="set-checkbox w-5 h-5 bg-stone-700 rounded text-indigo-500 focus:ring-0">
                            <label for="set-${i}" class="ml-3 font-semibold">Set ${i} Completed</label>
                        </div>`;
                    }

                    content.innerHTML = `
                        <div class="flex flex-col md:flex-row gap-8">
                            <!-- Left Side: Image and Description -->
                            <div class="flex-1 text-center">
                                <div class="w-full h-48 bg-stone-900 rounded-lg flex items-center justify-center mb-4">
                                    <!-- Placeholder for muscle group image -->
                                    <p class="text-stone-500 text-2xl">[${ex.name} Image]</p>
                                </div>
                                <p class="text-stone-300">${ex.instructions[0]}</p> <!-- Show first instruction as a summary -->
                            </div>

                            <!-- Right Side: Task Details and Actions -->
                            <div class="flex-1">
                                <p class="text-sm text-stone-400">Task ${index + 1} / ${exercises.length}</p>
                                <h2 class="text-3xl font-bold mb-2">${ex.name}</h2>
                                <p class="text-xl text-indigo-400 mb-4">${ex.sets} sets of ${ex.reps} reps @ ${weight} kg</p>

                                <!-- Collapsible Instructions Section -->
                                <details class="mb-4">
                                    <summary class="cursor-pointer text-indigo-400">View Full Instructions</summary>
                                    <ul class="list-disc list-inside text-left space-y-1 mt-2 text-stone-300">
                                        ${ex.instructions.map(step => `<li>${step}</li>`).join('')}
                                    </ul>
                                </details>

                                <div class="space-y-2 mb-6">
                                    ${setsHtml}
                                </div>

                                <div class="flex gap-4 justify-center">
                                    <button data-action="cancelDungeon" class="bg-red-600 hover:bg-red-500 py-2 px-4 rounded">Cancel Quest</button>
                                    <button data-action="nextDungeonTask" class="btn-primary py-2 px-6 rounded" disabled>Next Task</button>
                                </div>
                            </div>
                        </div>
                    `;

                    const nextBtn = document.querySelector('[data-action="nextDungeonTask"]');
                    const checkIfComplete = () => {
                        const all = Array.from(document.querySelectorAll('.set-checkbox'));
                        if (nextBtn) nextBtn.disabled = !all.every(cb => cb.checked);
                    };
                    document.querySelectorAll('.set-checkbox').forEach(cb => cb.addEventListener('change', checkIfComplete));
                    checkIfComplete();
                }
            },
            
            nextDungeonTask() {
                this.state.dungeon.currentExerciseIndex++;
                this.renderDungeon();
            },

            completeDungeon() {
                this.state.dungeon.isActive = false;
                document.getElementById('dungeon-overlay').classList.add('hidden');
                document.getElementById('dungeon-overlay').classList.remove('flex');
                // Calculate volume and apply progressive overload
                const difficultyInc = { 'Easy': 1.25, 'Normal': 2.5, 'Hard': 5 }[this.state.difficulty] || 2.5;
                const mainLifts = new Set(['Squat', 'Bench Press', 'Deadlift', 'Overhead Press', 'Barbell Row']);
                let sessionVolume = 0;
                this.state.dungeon.exercises.forEach(ex => {
                    const lift = this.state.lifts[ex.name];
                    const weight = lift ? lift.weight : 0;
                    const repsNums = (ex.reps.match(/\d+/g) || []).map(n => parseInt(n));
                    const reps = repsNums.length ? Math.max(...repsNums) : 8;
                    sessionVolume += (ex.sets || 0) * reps * weight;
                    if (mainLifts.has(ex.name) && lift) {
                        lift.weight = Math.round((lift.weight + difficultyInc) * 100) / 100;
                        // record history point
                        const hist = this.state.liftHistory[ex.name] || [];
                        hist.push({ date: new Date().toISOString(), weight: lift.weight });
                        this.state.liftHistory[ex.name] = hist;
                    }
                });
                this.state.stats.totalVolumeKg += Math.round(sessionVolume);

                // Update stats and streak
                this.state.stats.totalWorkouts++;
                this.state.stats.dungeonsCleared++;
                // XP and Mana
                const xpGain = 50 + Math.round(sessionVolume / 500);
                this.state.xp += xpGain;
                this.state.mana += 50;
                let leveledUp = false;
                while (this.state.xp >= this.state.xpToNextLevel) {
                    this.state.xp -= this.state.xpToNextLevel;
                    this.state.level++;
                    this.state.xpToNextLevel = Math.round(this.state.xpToNextLevel * 1.2);
                    leveledUp = true;
                }
                const today = new Date().toISOString().split('T')[0];
                if (!this.state.lastWorkoutDate) {
                    this.state.streak = 1;
                } else {
                    const last = new Date(this.state.lastWorkoutDate);
                    const now = new Date(today);
                    const diffDays = Math.round((now - last) / (1000*60*60*24));
                    if (diffDays === 1) this.state.streak++;
                    else if (diffDays > 1) this.state.streak = 1;
                }
                this.state.lastWorkoutDate = today;
                this.state.longestStreak = Math.max(this.state.longestStreak || 0, this.state.streak);

                this.state.activityLog.push({ date: new Date().toISOString().split('T')[0], type: 'workout' });
                this.saveData();
                // Refresh achievements view if open
                if (document.getElementById('achievements-page').classList.contains('active')) this.renderAchievementsPage();
                this.renderDashboard();
                // Level up animation modal
                if (leveledUp) {
                    this.showModal({
                        title: 'Level Up!',
                        html: `<div class=\"text-center\"><div class=\"text-5xl font-black text-indigo-400 level-up\">Lv ${this.state.level}</div><p class=\"mt-2 text-gray-300\">Your power grows.</p></div>`,
                        actions: [{ label: 'Continue', primary: true, onClick: () => {} }]
                    });
                } else {
                    this.modalAlert("Workout logged!");
                }
            },

            cancelDungeon() {
                this.modalConfirm("Are you sure you want to abandon the quest? Your progress will not be saved.").then((ok) => {
                    if (ok) {
                    this.state.dungeon.isActive = false;
                    document.getElementById('dungeon-overlay').classList.add('hidden');
                    document.getElementById('dungeon-overlay').classList.remove('flex');
                }
                });
            },
            
            generateGate() {
                // Randomly spawn multiple gates, each with timers
                if (!Array.isArray(this.state.gates)) this.state.gates = [];
                if (!Array.isArray(this.state.completedGates)) this.state.completedGates = [];
                const now = Date.now();
                // Remove expired
                this.state.gates = this.state.gates.filter(g => g.expiresAt > now);
                if (Math.random() < 0.5 && this.state.gates.length < 3) {
                    // Filter out already active gates and recently completed gates
                    const availableGates = this.gatesData.filter(gate => {
                        const isActive = this.state.gates.some(active => active.rank === gate.rank);
                        const wasCompleted = this.state.completedGates.includes(gate.rank);
                        return !isActive && !wasCompleted;
                    });
                    
                    if (availableGates.length > 0) {
                        const base = availableGates[Math.floor(Math.random() * availableGates.length)];
                        const durations = { 'S': 60*60*1000, 'A': 3*60*60*1000, 'B': 6*60*60*1000, 'C': 12*60*60*1000, 'D': 18*60*60*1000, 'E': 24*60*60*1000 };
                        const expiresAt = now + (durations[base.rank] || 6*60*60*1000);
                        const id = `gate_${now}_${Math.random().toString(36).slice(2,7)}`;
                        this.state.gates.push({ id, ...base, createdAt: now, expiresAt });
                        this.saveData();
                    }
                }
                this.renderGatesPage();
            },

            completeGate(e, gateId) {
                const g = gateId ? (this.state.gates || []).find(x => x.id === gateId) : this.state.activeGate;
                const id = `gate-confirm-${Date.now()}`;
                const instance = this.showModal({
                    title: `${g.rank}-Rank Gate Confirmation`,
                    html: `<p class=\"text-gray-200 mb-3\">${g.description}</p><label class=\"flex items-center gap-2 text-sm\"><input type=\"checkbox\" id=\"${id}\" class=\"h-4 w-4\"> I confirm I completed this challenge.</label>`,
                    actions: [
                        { label: 'Cancel', onClick: () => instance.close() },
                        { label: 'Claim Reward', primary: true, onClick: () => {
                            const cb = document.getElementById(id);
                            if (!cb || !cb.checked) return;
                            instance.close();
                            this.modalAlert(`Gate Cleared! You earned ${g.reward} XP.`);
                            this.state.stats.gatesCleared++;
                            // Track rank-specific achievements
                            if (g.rank === 'S') this.state.stats.sRanksCleared++;
                            if (g.rank === 'A') this.state.stats.aRanksCleared++;
                            if (g.rank === 'B') this.state.stats.bRanksCleared++;
                            if (g.rank === 'C') this.state.stats.cRanksCleared++;
                            if (g.rank === 'D') this.state.stats.dRanksCleared++;
                            if (g.rank === 'E') this.state.stats.eRanksCleared++;
                            // Add to completed gates history
                            if (!this.state.completedGates.includes(g.rank)) {
                                this.state.completedGates.push(g.rank);
                            }
                            // grant XP and mana bonus
                            this.state.xp += g.reward;
                            this.state.mana += 25;
                            while (this.state.xp >= this.state.xpToNextLevel) {
                                this.state.xp -= this.state.xpToNextLevel;
                                this.state.level++;
                                this.state.xpToNextLevel = Math.round(this.state.xpToNextLevel * 1.2);
                            }
                            if (gateId) this.state.gates = (this.state.gates || []).filter(x => x.id !== gateId);
                            else this.state.activeGate = null;
                            this.state.activityLog.push({ date: new Date().toISOString().split('T')[0], type: 'gate' });
                            this.saveData();
                            this.renderWorkoutPage();
                            this.renderDashboard();
                            this.renderGatesPage();
                            if (document.getElementById('achievements-page').classList.contains('active')) this.renderAchievementsPage();
                        } }
                    ]
                });
            }
        };

        // --- AUTHENTICATION LISTENER ---
        onAuthStateChanged(auth, (user) => {
            const loginScreen = document.getElementById('login-screen');
            const appContent = document.getElementById('app-content');

            if (user) {
                console.log("User is signed in:", user.uid);
                app.state.user = user;
                loginScreen.classList.add('hidden');
                appContent.classList.remove('hidden');
                app.init();
                // init particles
                if (window.particlesJS) {
                    particlesJS('particles-dashboard', { particles: { number: { value: 40 }, color: { value: '#6366f1' }, shape: { type: 'circle' }, opacity: { value: 0.2 }, size: { value: 2 }, move: { enable: true, speed: 1 } }, interactivity: { events: { onhover: { enable: false } } }, retina_detect: true });
                }
            } else {
                console.log("User is signed out.");
                loginScreen.classList.remove('hidden');
                appContent.classList.add('hidden');
                app.state.isInitialized = false;
                if (window.particlesJS) {
                    particlesJS('particles-login', { particles: { number: { value: 35 }, color: { value: '#4f46e5' }, shape: { type: 'circle' }, opacity: { value: 0.25 }, size: { value: 2 }, move: { enable: true, speed: 1 } }, interactivity: { events: { onhover: { enable: false } } }, retina_detect: true });
                }
            }
        });

        // --- LOGIN BUTTON ---
        document.getElementById('login-btn').addEventListener('click', () => {
            signInWithPopup(auth, provider).catch((error) => {
                console.error("Login failed:", error);
                if (app && app.modalAlert) app.modalAlert("Login failed. Please check your Firebase setup and authorized domains.");
                else alert("Login failed. Please check your Firebase setup and authorized domains.");
            });
        });

    </script>
</body>
</html>
