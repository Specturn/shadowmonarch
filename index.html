<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Monarch 3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .card-bg { background-color: #1f2937; border: 1px solid #4b5563; }
        .btn-primary { background-color: #4f46e5; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #6366f1; }
        .nav-btn.active { background-color: #4f46e5; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-white">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center p-4">
        <h1 class="text-5xl font-black uppercase text-indigo-400 mb-2">Project Monarch</h1>
        <p class="text-gray-400 mb-8">Your path to unrivaled strength begins.</p>
        <button id="login-btn" class="btn-primary text-white font-bold py-3 px-6 rounded-lg flex items-center">
            <i class="fab fa-google mr-3"></i> Login with Google
        </button>
    </div>

    <!-- Main App Content (Initially Hidden) -->
    <div id="app-content" class="hidden max-w-4xl mx-auto p-4">
        <header class="text-center mb-6 p-8 rounded-lg card-bg">
            <h1 id="header-title" class="text-4xl font-black uppercase text-indigo-400">Dashboard</h1>
        </header>
        
        <nav class="flex justify-center gap-2 mb-6">
            <button data-page="dashboard" class="nav-btn active px-4 py-2 rounded-lg font-semibold">Dashboard</button>
            <button data-page="architect" class="nav-btn px-4 py-2 rounded-lg font-semibold">Architect</button>
            <button data-page="settings" class="nav-btn px-4 py-2 rounded-lg font-semibold">Settings</button>
        </nav>

        <main>
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page active">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 card-bg p-6 rounded-lg text-center">
                        <div id="avatar-container" class="relative w-32 h-32 mx-auto mb-4 cursor-pointer group">
                             <div id="avatar-placeholder" class="w-full h-full rounded-full border-2 border-dashed border-gray-600 flex items-center justify-center bg-gray-800">
                                <i class="fas fa-user text-4xl text-gray-500"></i>
                            </div>
                            <img id="dashboard-avatar-img" src="" class="hidden w-full h-full rounded-full object-cover border-2 border-indigo-500">
                            <div class="absolute inset-0 rounded-full bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fas fa-camera text-white text-2xl"></i>
                            </div>
                        </div>
                        <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
                        <h2 id="player-name-display" class="text-2xl font-bold">Player</h2>
                        <button id="edit-name-btn" class="text-sm text-gray-400 hover:text-white"><i class="fas fa-pencil-alt mr-1"></i> Edit Name</button>
                    </div>
                    <div class="md:col-span-2 card-bg p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4">Strength Stats</h3>
                        <div id="stats-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                            <!-- Stats will be rendered here -->
                             <p class="text-gray-400 col-span-full">Your workout stats will appear here once you start training.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Architect Page -->
            <div id="architect-page" class="page">
                <div class="card-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Create New Routine</h2>
                    <div class="space-y-4">
                        <input id="architect-routine-name" type="text" placeholder="Routine Name" class="w-full p-2 bg-gray-800 rounded border border-gray-700 focus:border-indigo-500 focus:ring-0">
                        <div id="architect-exercise-section" class="hidden space-y-2">
                            <div class="grid grid-cols-1 sm:grid-cols-4 gap-2 items-end">
                                <div class="sm:col-span-2">
                                    <label class="text-sm text-gray-400">Add Exercise</label>
                                    <select id="architect-exercise-select" class="w-full p-2 bg-gray-800 rounded border border-gray-700 focus:border-indigo-500 focus:ring-0"></select>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Sets</label>
                                    <input id="architect-sets" type="number" placeholder="e.g., 3" class="w-full p-2 bg-gray-800 rounded border border-gray-700 focus:border-indigo-500 focus:ring-0">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Reps</label>
                                    <input id="architect-reps" type="text" placeholder="e.g., 5-8" class="w-full p-2 bg-gray-800 rounded border border-gray-700 focus:border-indigo-500 focus:ring-0">
                                </div>
                            </div>
                            <button id="architect-add-exercise-btn" class="w-full btn-primary mt-2 py-2 rounded">Add Exercise to Routine</button>
                        </div>
                        <div id="architect-routine-preview" class="mt-4 space-y-2"></div>
                        <button id="architect-save-routine-btn" class="w-full bg-green-600 hover:bg-green-500 py-2 rounded mt-4 hidden">Save Routine</button>
                    </div>
                </div>
            </div>
            
            <!-- Settings Page -->
            <div id="settings-page" class="page">
                 <div class="card-bg p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Settings</h2>
                    <p class="text-gray-400">App settings will be available here in a future update.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===================================================================================
        // --- IMPORTANT: FIX FOR LOGIN ERROR ---
        // To fix the "Login failed" error, you need to replace the placeholder
        // values below with your actual Firebase project configuration.
        //
        // HOW TO GET YOUR CONFIG:
        // 1. Go to your Firebase project console.
        // 2. Click the gear icon (Project settings) in the top left.
        // 3. In the "General" tab, scroll down to the "Your apps" section.
        // 4. Find your web app and click on the "SDK setup and configuration" section.
        // 5. Select "Config".
        // 6. Copy the entire 'firebaseConfig' object and paste it here, replacing
        //    the placeholder object below.
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // --- FIREBASE INITIALIZATION ---
        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const provider = new GoogleAuthProvider();

        // --- MAIN APPLICATION OBJECT ---
        const app = {
            state: {
                user: null,
                isInitialized: false,
                playerName: 'Player',
                customAvatar: null,
                currentCustomWorkout: { name: '', exercises: [] },
                savedRoutines: [],
            },

            masterExerciseList: [
                'Squat', 'Bench Press', 'Deadlift', 'Overhead Press', 'Barbell Row', 
                'Romanian Deadlift', 'Front Squat', 'Hip Thrust', 'Dumbbell Bench Press', 
                'Incline DB Press', 'Dumbbell Row', 'Goblet Squat', 'Bulgarian Split Squat', 
                'Dumbbell Shoulder Press', 'Lateral Raise', 'Dumbbell Curl', 'Hammer Curl', 
                'Tricep Skullcrusher', 'Lat Pulldown', 'Cable Row', 'Tricep Pushdown', 
                'Leg Press', 'Leg Extension', 'Hamstring Curl', 'Calf Raise', 'Pull-up', 'Dip'
            ],

            // --- CORE LIFECYCLE ---
            init() {
                if (this.state.isInitialized) return;
                console.log("App Initializing...");
                this.loadData().then(() => {
                    this.render();
                    this.bindEvents();
                    this.state.isInitialized = true;
                    console.log("App Initialized Successfully.");
                });
            },

            async loadData() {
                if (!this.state.user) return;
                const userRef = doc(db, "users", this.state.user.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    this.state.playerName = data.playerName || 'Player';
                    this.state.customAvatar = data.customAvatar || null;
                    this.state.savedRoutines = data.savedRoutines || [];
                } else {
                    await this.saveData(); // Create initial document for new user
                }
            },

            async saveData() {
                if (!this.state.user) return;
                const userRef = doc(db, "users", this.state.user.uid);
                try {
                    await setDoc(userRef, {
                        playerName: this.state.playerName,
                        customAvatar: this.state.customAvatar,
                        savedRoutines: this.state.savedRoutines,
                    }, { merge: true });
                    console.log("Data saved to Firestore.");
                } catch (error) {
                    console.error("Error saving data:", error);
                    alert("Error saving progress to the cloud.");
                }
            },

            // --- EVENT BINDING ---
            bindEvents() {
                console.log("Binding all application events...");
                // Navigation
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.showPage(btn.dataset.page));
                });

                // Dashboard
                document.getElementById('edit-name-btn').addEventListener('click', () => this.editPlayerName());
                document.getElementById('avatar-container').addEventListener('click', () => document.getElementById('avatar-upload-input').click());
                document.getElementById('avatar-upload-input').addEventListener('change', (e) => this.handleAvatarUpload(e));

                // Architect
                document.getElementById('architect-routine-name').addEventListener('input', (e) => this.handleRoutineNameInput(e));
                document.getElementById('architect-add-exercise-btn').addEventListener('click', () => this.addExerciseToRoutine());
                document.getElementById('architect-save-routine-btn').addEventListener('click', () => this.saveCurrentRoutine());
                
                console.log("Event binding complete.");
            },

            // --- UI & RENDERING ---
            render() {
                this.renderDashboard();
                this.renderArchitect();
            },

            renderDashboard() {
                document.getElementById('player-name-display').textContent = this.state.playerName;
                const avatarImg = document.getElementById('dashboard-avatar-img');
                const avatarPlaceholder = document.getElementById('avatar-placeholder');
                if (this.state.customAvatar) {
                    avatarImg.src = this.state.customAvatar;
                    avatarImg.classList.remove('hidden');
                    avatarPlaceholder.classList.add('hidden');
                } else {
                    avatarImg.classList.add('hidden');
                    avatarPlaceholder.classList.remove('hidden');
                }
            },
            
            renderArchitect() {
                const previewContainer = document.getElementById('architect-routine-preview');
                previewContainer.innerHTML = '';
                 if(this.state.currentCustomWorkout.exercises.length > 0){
                    const title = document.createElement('h4');
                    title.textContent = "Routine Preview:";
                    title.className = "font-bold text-lg";
                    previewContainer.appendChild(title);
                }
                this.state.currentCustomWorkout.exercises.forEach((ex, index) => {
                    const p = document.createElement('div');
                    p.className = 'p-2 bg-gray-800 rounded flex justify-between items-center';
                    p.innerHTML = `<span>${ex.name}: ${ex.sets} sets of ${ex.reps} reps</span><button data-index="${index}" class="remove-exercise-btn text-red-500 hover:text-red-400">âœ–</button>`;
                    previewContainer.appendChild(p);
                });
                
                // Add event listeners for new remove buttons
                document.querySelectorAll('.remove-exercise-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        this.removeExerciseFromRoutine(index);
                    });
                });

                const saveBtn = document.getElementById('architect-save-routine-btn');
                if(this.state.currentCustomWorkout.name && this.state.currentCustomWorkout.exercises.length > 0){
                    saveBtn.classList.remove('hidden');
                } else {
                    saveBtn.classList.add('hidden');
                }
            },

            showPage(pageId) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(`${pageId}-page`).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`.nav-btn[data-page="${pageId}"]`).classList.add('active');
                document.getElementById('header-title').textContent = pageId.charAt(0).toUpperCase() + pageId.slice(1);
                if(pageId === 'architect') this.populateExerciseDropdown();
            },
            
            // --- ACTION HANDLERS ---
            editPlayerName() {
                const newName = prompt("Enter your new name:", this.state.playerName);
                if (newName && newName.trim() !== "") {
                    this.state.playerName = newName.trim();
                    this.saveData();
                    this.renderDashboard();
                }
            },

            handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.state.customAvatar = e.target.result;
                    this.saveData();
                    this.renderDashboard();
                };
                reader.readAsDataURL(file);
            },
            
            handleRoutineNameInput(event) {
                const name = event.target.value.trim();
                const exerciseSection = document.getElementById('architect-exercise-section');
                if (name) {
                    this.state.currentCustomWorkout.name = name;
                    exerciseSection.classList.remove('hidden');
                } else {
                    exerciseSection.classList.add('hidden');
                }
                this.renderArchitect();
            },
            
            populateExerciseDropdown() {
                const selectEl = document.getElementById('architect-exercise-select');
                selectEl.innerHTML = '<option value="" disabled selected>Select an exercise...</option>';
                this.masterExerciseList.forEach(exercise => {
                    const option = document.createElement('option');
                    option.value = exercise;
                    option.textContent = exercise;
                    selectEl.appendChild(option);
                });
            },

            addExerciseToRoutine() {
                const exerciseSelect = document.getElementById('architect-exercise-select');
                const setsInput = document.getElementById('architect-sets');
                const repsInput = document.getElementById('architect-reps');

                if (exerciseSelect.value && setsInput.value && repsInput.value) {
                    this.state.currentCustomWorkout.exercises.push({ 
                        name: exerciseSelect.value, 
                        sets: setsInput.value, 
                        reps: repsInput.value 
                    });
                    this.renderArchitect();
                    // Clear inputs
                    exerciseSelect.value = '';
                    setsInput.value = '';
                    repsInput.value = '';
                } else {
                    alert("Please fill out all exercise fields.");
                }
            },

            removeExerciseFromRoutine(index) {
                this.state.currentCustomWorkout.exercises.splice(index, 1);
                this.renderArchitect();
            },

            saveCurrentRoutine() {
                this.state.savedRoutines.push(this.state.currentCustomWorkout);
                this.saveData();
                alert(`Routine "${this.state.currentCustomWorkout.name}" saved!`);
                // Reset architect
                this.state.currentCustomWorkout = { name: '', exercises: [] };
                document.getElementById('architect-routine-name').value = '';
                document.getElementById('architect-exercise-section').classList.add('hidden');
                this.renderArchitect();
            }
        };

        // --- AUTHENTICATION LISTENER ---
        onAuthStateChanged(auth, (user) => {
            const loginScreen = document.getElementById('login-screen');
            const appContent = document.getElementById('app-content');

            if (user) {
                console.log("User is signed in:", user.uid);
                app.state.user = user;
                loginScreen.classList.add('hidden');
                appContent.classList.remove('hidden');
                app.init(); // Initialize app AFTER user is confirmed and UI is visible
            } else {
                console.log("User is signed out.");
                loginScreen.classList.remove('hidden');
                appContent.classList.add('hidden');
                app.state.isInitialized = false; // Reset init flag on logout
            }
        });

        // --- LOGIN BUTTON ---
        document.getElementById('login-btn').addEventListener('click', () => {
            signInWithPopup(auth, provider).catch((error) => {
                console.error("Login failed:", error);
                alert("Login failed. Please check your Firebase setup and authorized domains.");
            });
        });

    </script>
</body>
</html>
